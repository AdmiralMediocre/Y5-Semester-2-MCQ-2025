<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multiple Choice Question Preparation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Github Model Styles */
    :root {
      --primary: #007bff; --secondary: #6c757d; --success: #28a745; --danger: #dc3545;
      --background: #fff; --text: #212529; --border: #dee2e6;
      --light-bg: #f8f9fa; --card-bg: #ffffff; --shadow: 0 4px 6px rgba(0,0,0,0.1);
      --correct: #28a745; --wrong: #dc3545; --error: #dc3545;
    }
    body.dark {
      --primary: #4dabf7; --secondary: #909296; --success: #40c057; --danger: #fa5252;
      --background: #1a1b1e; --text: #c1c2c5; --border: #373A40;
      --light-bg: #25262b; --card-bg: #2c2e33; --shadow: 0 4px 6px rgba(0,0,0,0.2);
      --correct: #40c057; --wrong: #fa5252;
    }
    body {
      font-family: 'Inter', sans-serif; margin: 0; background-color: var(--background);
      color: var(--text); transition: background-color 0.2s, color 0.2s;
    }
    .container { max-width: 900px; margin: 20px auto; padding: 20px; }
    h1, h2, h3 { color: var(--text); }
    button, .menu-button {
      border: none; padding: 10px 15px; border-radius: 8px; font-weight: 600;
      cursor: pointer; transition: all 0.2s, box-shadow 0.2s;
      background-color: var(--primary); color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button:hover, .menu-button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    button:active, .menu-button:active, .response-box:active {
        transform: scale(0.98);
        opacity: 1;
    }
    button:disabled { background-color: var(--secondary); cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-secondary { background-color: var(--secondary); }
    .btn-danger { background-color: var(--danger); }
    .global-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header-icons .icon-btn { background: none; font-size: 1.5rem; padding: 5px; color: var(--text); box-shadow: none; }
    .main-menu { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
    .menu-button {
        background-color: var(--card-bg); color: var(--text); text-align: center; font-size: 1.1rem;
        padding: 20px 15px; box-shadow: var(--shadow); border: 1px solid var(--border);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        min-height: 120px;
    }
    .question-card { background-color: var(--card-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); }
    .response-box { padding: 12px; margin: 8px 0; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; transition: transform 0.15s, background-color 0.2s, border-color 0.2s; }
    .response-box:hover {
        background-color: var(--light-bg);
        border-color: var(--primary);
        transform: scale(1.01);
    }
    .response-box.correct { background-color: #d4edda; border-color: #c3e6cb; color: #155724; font-weight: bold; }
    .response-box.wrong { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; font-weight: bold; }
    body.dark .response-box.correct { background-color: #2b5a3a; border-color: #3f7d4d; color: #a3e9a4; }
    body.dark .response-box.wrong { background-color: #6b2a33; border-color: #8b3d48; color: #f5c2c7; }
    .response-prefix { font-weight: bold; margin-right: 10px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 500; }
    input[type="text"], input[type="number"], select, textarea {
        width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px;
        background-color: var(--background); color: var(--text); box-sizing: border-box;
    }
    .progress-bar-wrap { height: 10px; background-color: var(--border); border-radius: 5px; overflow: hidden; }
    .progress-bar { height: 100%; background-color: var(--primary); transition: width 0.3s; }
    .score-bar { font-size: 2rem; font-weight: bold; padding: 20px; background-color: var(--light-bg); border-radius: 8px; text-align: center; }
    .score-remark { font-size: 1.2rem; margin-top: 15px; text-align: center; }

    /* === USER REQUEST: Larger Menu & Instruction Styles === */
    .menu-icon {
        font-size: 2.5rem;
        margin-bottom: 8px;
    }
    .instruction-page h3 {
        font-size: 1.6rem;
        margin-top: 25px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 8px;
    }
    .instruction-page p {
        font-size: 1.2rem;
        line-height: 1.6;
    }
    /* ======================================================= */

    /* === Moodle Model Specific Styles & Dark Mode Overrides === */
    .nav-btn { transition: all 0.2s ease-in-out; position: relative; }
    .nav-btn-default { background-color: #ffffff; color: #374151; border: 1px solid #d1d5db; }
    .nav-btn-current { background-color: #3b82f6; color: #ffffff; border-color: #3b82f6; transform: scale(1.1); }
    .nav-btn-correct { background-color: #22c55e; color: #ffffff; border-color: #22c55e; }
    .nav-btn-incorrect { background-color: #ef4444; color: #ffffff; border-color: #ef4444; }
    .flag-icon { position: absolute; top: -4px; right: -2px; font-size: 14px; color: #f59e0b; }
    .option-correct { background-color: #dcfce7; border-color: #22c55e; color: #166534; font-weight: 600; }
    .option-incorrect { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; font-weight: 600; }
    body.dark #moodle-quiz-container { --tw-bg-opacity: 1; background-color: var(--background); color: var(--text); }
    body.dark #moodle-quiz-container .bg-white { background-color: var(--card-bg); }
    body.dark #moodle-quiz-container .bg-slate-50 { background-color: var(--light-bg); }
    body.dark #moodle-quiz-container .bg-slate-200 { background-color: var(--secondary); color: white; }
    body.dark #moodle-quiz-container .text-slate-500 { color: #909296; }
    body.dark #moodle-quiz-container .text-slate-600, body.dark #moodle-quiz-container .text-slate-700, body.dark #moodle-quiz-container .text-slate-800 { color: var(--text); }
    body.dark #moodle-quiz-container .border, body.dark #moodle-quiz-container .border-slate-200, body.dark #moodle-quiz-container .border-slate-300 { border-color: var(--border); }
    body.dark #moodle-quiz-container input, body.dark #moodle-quiz-container select { background-color: var(--background); color: var(--text); }
    body.dark #moodle-quiz-container .option-correct { background-color: #2b5a3a; border-color: #3f7d4d; color: #a3e9a4; }
    body.dark #moodle-quiz-container .option-incorrect { background-color: #6b2a33; border-color: #8b3d48; color: #f5c2c7; }
    body.dark #moodle-quiz-container .nav-btn-default { background-color: var(--light-bg); color: var(--text); border-color: var(--border); }

    /* === USER REQUESTED UI CHANGES FOR SETUP SCREENS === */
    .setup-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border);
        padding: 25px;
        border-radius: 12px;
        margin-top: 20px;
        box-shadow: var(--shadow);
    }
    .setup-card p {
        margin: 0 0 20px 0;
        font-size: 1.1rem;
        color: var(--text);
    }
    .setup-card .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        align-items: center;
    }
    .setup-card .form-group {
        margin-bottom: 0;
    }
    .setup-card .form-group label {
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 8px;
    }
    .setup-card .range-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .setup-card .range-group label {
        margin: 0;
        font-size: 1rem;
        font-weight: 500;
    }
    .setup-card .range-group input {
        width: 80px;
        text-align: center;
    }
    .setup-card .button-group {
        margin-top: 25px;
        display: flex;
        gap: 15px;
    }
    .setup-card button {
        padding: 12px 20px;
        font-size: 1rem;
    }
     /* ======================================================= */
  </style>
</head>
<body>

<audio id="bg-music" loop></audio>
<div class="container" id="app"></div>

<script>
// --- Data structure, Keys, and Constants ---
const MAIN_BANK_KEY = "mcq_main_bank_v4";
const MEMORY_LIST_KEY = "mcq_memory_list_v4";
const SETTINGS_KEY = "mcq_settings_v4";

// --- State Management ---
function getDefaultState() {
  return {
    view: "menu",
    mainQuestionBank: [
     {
    question: "វិធីសាស្ត្រព្យាបាលរោគដោយវេជ្ជសាស្ត្រគឺប្រើ៖",
    img: "",
    responses: [
      "តាមរបបចំណីអាហារ",
      "ការបញ្ចាំងតាមសីររៈវិជ្ជា",
      "ឈាម",
      "ការផ្លាស់ប្តូរទីតាំង",
      "ការព្យាបាលដោយចលនា"
    ],
    correct: 2
  },
  {
    question: "គោលបំណងនៃការព្យាបាលដោយវេជ្ជសាស្ត្រមាន៖",
    img: "",
    responses: [
      "គោលបំណងអោយជាសះស្បើយ",
      "គោលបំណងរោគវិនិច្ឆ័យ",
      "គោលបំណងព្យាបាលដោយចិត្តសាស្ត្រ",
      "ប្រសិទ្ធិភាពព្យាបាលដោយវេជ្ជសាស្ត្រ",
      "ចំលើយទាំងអស់ត្រឹមត្រូវ"
    ],
    correct: 4
  },
  {
    question: "គោលបំណងនៃការព្យាបាលអោយជាសះស្បើយគឺ",
    img: "",
    responses: [
      "សំដៅព្យាបាលលើមូលហេតុបង្ករោគដំណើរនៃជម្ងឺ (mécanisme)",
      "រោគវិនិច្ឆ័យត្រូវប្រាកដ",
      "ព្យាបាលដោយចិត្តសាស្ត្រ",
      "សំដៅព្យាបាលលើរោគសញ្ញា",
      "ចំលើយទាំងអស់ត្រឹមត្រូវ"
    ],
    correct: 0
  },
  {
    question: "ការព្យាបាលដោយសំដៅព្យាបាលលើមូលហេតុបង្ករោគដំណើរ នៃជំងឺរឺដោយរោគសញ្ញា គឺជាការព្យាបាលមួយក្នុងគោលបំណង៖",
    img: "",
    responses: [
      "គោលបំណងអោយជាសះស្បើយ",
      "គោលបំណងរោគវិនិច្ឆ័យ",
      "គោលបំណងព្យាបាលដោយចិត្តសាស្ត្រ",
      "ប្រសិទ្ធិភាពព្យាបាលដោយវេជ្ជសាស្ត្រ",
      "ចំលើយទាំងអស់ត្រឹមត្រូវ"
    ],
    correct: 0
  },
  {
    question: "ការព្យាបាលតាមវិញ្ញាសាពិនិត្យក្នុងគោលបំណង៖",
    img: "",
    responses: [
      "គោលបំណងអោយជាសះស្បើយ",
      "គោលបំណងរោគវិនិច្ឆ័យ",
      "គោលបំណងព្យាបាលដោយចិត្តសាស្ត្រ",
      "ប្រសិទ្ធិភាពព្យាបាលដោយវេជ្ជសាស្ត្រ",
      "ចំលើយទាំងអស់ត្រឹមត្រូវ"
    ],
    correct: 1
  },
  {
    question: "ការព្យាបាលដោយលោកគ្រូពេទ្យឯកទេសផ្ទាល់ដូចជាក្នុងការចាក់ថ្នាំតាមសរសៃជាដើមគឺក្នុងគោលបំណង៖",
    img: "",
    responses: [
      "គោលបំណងអោយជាសះស្បើយ",
      "គោលបំណងរោគវិនិច្ឆ័យ",
      "គោលបំណងព្យាបាលដោយចិត្តសាស្ត្រ",
      "ប្រសិទ្ធិភាពព្យាបាលដោយវេជ្ជសាស្ត្រ"
    ],
    correct: 2
  },
  {
    question: "គុណភាពនៃការព្យាបាលដ៏ល្អគឺគ្រូពេទ្យត្រូវតែផ្អែកទៅលើចំនុចពិសេសដោយឡែកនៃករណីនីមួយការព្យាបាលនៃកំរិតប្រើប្រាស់ថ្នាំតាមបុគ្គលអ្នកជំងឺនីមួយៗដោយយោងទៅតាម៖",
    img: "",
    responses: [
      "ការសំរបសំរួល សំរួលរបស់បុគ្គលអ្នកជំងឺ",
      "អតិបរមានៃប្រសិទ្ធិភាព",
      "ការសំរបសំរួលសង្គម",
      "ការព្យាបាលដោយឆ្លងកាត់សព្វគ្រប់មិនអាចតាងថាជាអតិបរមានៃការប្រឹងប្រែងព្យាបាលទេ",
      "ចំលើយទាំងអស់ត្រឹមត្រូវ"
    ],
    correct: 4
  },
  {
    question: "គុណភាពនៃការព្យាបាលដ៏ល្អគឺគ្រូពេទ្យត្រូវជៀសវាងការព្យាបាលដោយសាកល្បងម្តងហើយម្តងទៀត ហើយពន្យាពេលដោយឥតប្រយោជន៍នូវការវិវត្តន៍នៃជំងឺនេះចង់និយាយអំពី៖",
    img: "",
    responses: [
      "ការសំរបសំរួលនៃបុគ្គលអ្នកជំងឺ",
      "អតិបរមានៃប្រសិទ្ធិភាព",
      "ការសំរបសំរួលសង្គម",
      "ការព្យាបាលដោយឆ្លងកាត់សព្វគ្រប់មិនអាចតាងថាជាអតិបរមានៃការប្រឹងប្រែងព្យាបាលទេ"
    ],
    correct: 1
  },
  {
    question: "ការព្យាបាលដ៏ល្អប្រកបដោយគុណភាពនោះ គឺគ្រូពេទ្យព្យាបាលត្រូវតែគិតលើទិដ្ឋភាពចំណាយឱសថ ក្នុងការព្យាបាលត្រូវជាសះស្បើយ ឬការផ្លាសប្តូរទីតាំងជាដើម ចង់និយាយអំពី៖",
    img: "",
    responses: [
      "ការសំរបសំរួលនៃបុគ្គលអ្នកជំងឺ",
      "អតិបរមានៃប្រសិទ្ធិភាព",
      "ការសំរបសំរួលសង្គម",
      "ការព្យាបាលដោយឆ្លងកាត់សព្វគ្រប់មិនអាចតាងថាជាអតិបរមានៃការប្រឹងប្រែងព្យាបាលទេ"
    ],
    correct: 2
  },
  {
    question: "គុណវិបត្តិដែលត្រូវជៀសវាងក្នុងការព្យាបាលដោយវេជ្ជសាស្ត្រ៖",
    img: "",
    responses: [
      "គ្រូពេទ្យត្រូវគោរពច្បាប់ក្រមសិលធម៌វិជ្ជាជីវៈ",
      "គ្រូពេទ្យមិនគោរពច្បាប់ក្រមសិលធម៌វិជ្ជាជីវៈ",
      "គ្រូពេទ្យត្រូវអោយដំបូន្មានទៅអ្នកជំងឺដោយមានភាពស្មោះត្រង់",
      "គ្រូពេទ្យត្រូវអោយដំបូន្មានទៅអ្នកជំងឺដោយបាត់បង់ភាពស្មោះត្រង់",
      "ចំលើយទាំងអស់ត្រឹមត្រូវ"
    ],
    correct: 4
  },
  {
    question: "គុណវិបត្តិដែលត្រូវជៀសវាងក្នុងការព្យាបាលដោយវេជ្ជសាស្ត្រ៖",
    img: "",
    responses: [
      "គ្រូពេទ្យត្រូវគោរពច្បាប់ក្រមសិលធម៌វិជ្ជាជីវៈ",
      "គ្រូពេទ្យគ្មានការត្រួតពិនិត្យលើការលេចឡើង ស្លឹកស្មាញដែលឃើញនៅពេលខាងមុខ",
      "គ្រូពេទ្យខ្វះការប្រុងប្រយ័ត្នចំពោះថ្នាំ ដែលមានញៀនជាតិពុលត្រូវបានកើតឡើងបន្ទាប់ពីវេជ្ជបញ្ជា",
      "គ្រូពេទ្យអោយដំបូន្មានទៅអ្នកជំងឺ ដោយមានភាពស្មោះត្រង់",
      "គ្រូពេទ្យគ្មានការត្រួតពិនិត្យលើការលេចឡើង ស្លុគស្មាញដែលឃើញនៅពេលខាងមុខ, គ្រូពេទ្យខ្វះការប្រុងប្រយ័ត្នចំពោះថ្នាំ ដែលមានញៀនជាតិពុលត្រូវបានកើតឡើងបន្ទាប់ពីវេជ្ជបញ្ជា"
    ],
    correct: 4
  },
  {
    question: "ភាពសហការរបស់អ្នកជំងឺជាគោលការណ៍គឺ៖",
    img: "",
    responses: [
      "អ្នកជំងឺត្រូវផ្តល់ការព្រមព្រៀងរបស់ខ្លួនព្យាបាលតាមវេជ្ជសាស្ត្រ",
      "អ្នកជំងឺមិនចាំបាច់ការព្រមព្រៀងរបស់ខ្លួនក្នុងការព្យាបាលតាមវេជ្ជសាស្ត្រទេ",
      "គ្រូពេទ្យត្រូវតែពន្យល់ដល់អ្នកជំងឺអំពីគុណវិបត្តិ និងគុណសម្បត្តិក្នុងការព្យាបាលដែលអ្នកជំងឺស្នើឡើង",
      "ការយល់ព្រមរបស់អ្នកជំងឺឬអ្នកអមជុំវិញគឺជាការចាំបាច់ក្នុងឱកាសប្រើវិធីព្យាបាលដោយចិត្តសាស្ត្រ",
      "ចំលើយទាំងអស់ត្រឹមត្រូវ"
    ],
    correct: 0
  },
  {
    question: "ការផ្តល់អោយមានការព្រមព្រៀងរបស់អ្នកជំងឺ ក្នុងការព្យាបាលដោយវេជ្ជសាស្រ្តភាពសហការរបស់អ្នកជំងឺនេះជា៖",
    img: "",
    responses: [
      "ជាគោលការណ៍",
      "អនុសាសន៍",
      "ការត្រួតពិនិត្យ",
      "ការបញ្ជា"
    ],
    correct: 0
  },
  {
    question: "ការពន្យល់ដោយគ្រូពេទ្យលើការប្រើប្រាស់ឱសថអោយបានត្រឹមត្រូវ តាមវេជ្ជបញ្ជានិងត្រូវច្បាស់លាស់បង្ហាញប្រាប់អ្នកនៅជុំវិញអ្នកជំងឺ ភាពសហការរបស់អ្នកជំងឺនេះជា៖",
    img: "",
    responses: [
      "ជាគោលការណ៍",
      "អនុសាសន៍",
      "ការត្រួតពិនិត្យ",
      "ការបញ្ជា"
    ],
    correct: 1
  },
  {
    question: "អ្នកជំងឺបានទទួលយកដោយពិតប្រាកដ តាមវេជ្ជបញ្ជារបស់គ្រូពេទ្យត្រូវ តែមានការគ្រប់គ្រងធ្វើអោយបានដូចជាអ្នកជំងឺឈានដល់ទទួលយកការលេបថ្នាំ ឬក៍អនុវត្តន៍តាមរបបហូបចុកអាហារទៀងទាត់ ភាពសហការរបស់អ្នកជំងឺនេះជា៖",
    img: "",
    responses: [
      "ជាគោលការណ៍",
      "អនុសាសន៍",
      "ការត្រួតពិនិត្យ",
      "ការបញ្ជា"
    ],
    correct: 2
  },
  {
    question: "ភាពឯករាជ្យរបស់គ្រូពេទ្យក្នុងវិធីព្យាបាលរោគតាមវេជ្ជសាស្ត្រ៖",
    img: "",
    responses: [
      "គ្រូពេទ្យមានសិទ្ធិសំរេចចិត្តដោយឯកឯងជ្រើសរើសរកវិធីព្យាបាលរោគ",
      "គ្រូពេទ្យគ្មានសិទ្ធិសំរេចចិត្តដោយឯកឯងជ្រើសរើសរកវិធីព្យាបាលរោគ",
      "គ្រូពេទ្យអនុវត្តន៍វិធីព្យាបាលរោគដោយបង្ខំតាមទិសដៅរបស់មន្ទីរពេទ្យរីតាមយន្តការធានាមួយ",
      "គ្រូពេទ្យអនុវត្តន៍វិធីព្យាបាលរោគតាមអ្នកជំងឺខ្លួនឯង រឺអ្នកអមនៅជុំវិញអ្នកជំងឺ"
    ],
    correct: 0
  },
  {
    question: "ការទទួលខុសត្រូវផ្នែករដ្ឋប្បវេណីរបស់គ្រូពេទ្យ ដោយមូលហេតុនៃរោគវិភាគខុស ឬចំពោះមូលហេតុផ្សេង ណាមួយទៀតគ្រូពេទ្យមិនបានផ្តល់ឲ្យអ្នកជំងឺនូវការព្យាបាលត្រឹមត្រូវ នេះជាកំហុស៖",
    img: "",
    responses: [
      "កំហុសនៃការព្យាបាល",
      "កំហុសចេញវេជ្ជបញ្ជា",
      "ភាពមិនបានព្យាបាល",
      "ការមិនប្រុងប្រយ័ត្នក្នុងវិធីព្យាបាលរោគ"
    ],
    correct: 0
  },
  {
    question: "ការទទួលខុសត្រូវផ្នែករដ្ឋប្បវេណីរបស់គ្រូពេទ្យ ដោយការរៀបចំតាក់តែង បទបញ្ជា សថគ្រូពេទ្យមានកំហុសមួយ គឺចែងខុសថ្នាំឬកំរិតដែលប្រើប្រាស់ថ្នាំនេះជាកំហុស៖",
    img: "",
    responses: [
      "កំហុសនៃការព្យាបាល",
      "កំហុសចេញវេជ្ជបញ្ជា",
      "ភាពមិនបានព្យាបាល",
      "ការមិនប្រុងប្រយ័ត្នក្នុងវិធីព្យាបាលរោគ"
    ],
    correct: 1
  },
  {
    question: "ការទទួលខុសត្រូវផ្នែករដ្ឋប្បវេណីរបស់គ្រូពេទ្យ ក៏គ្រូពេទ្យមិនបានចេញវេជ្ជបញ្ជាព្យាបាលតាមការចាំបាច់ អ្នកជំងឺទទួលគ្រោះខូចខាត។ នេះជាកំហុស៖",
    img: "",
    responses: [
      "កំហុសនៃការព្យាបាល",
      "កំហុសចេញវេជ្ជបញ្ជា",
      "ភាពមិនបានព្យាបាល",
      "ការមិនប្រុងប្រយ័ត្នក្នុងវិធីព្យាបាលរោគ"
    ],
    correct: 2
  },
  {
    question: "ការទទួលខុសត្រូវផ្នែករដ្ឋប្បវេណីរបស់គ្រូពេទ្យ គឺគ្រូពេទ្យមិនបានគិតលើការផ្ទុយស្រឡះពីការចង្អុល ភាពដែលអាចកើតគ្រោះថ្នាក់ពីការប្រើប្រាស់សេរ៉ូម នេះជាកំហុស៖",
    img: "",
    responses: [
      "កំហុសនៃការព្យាបាល",
      "កំហុសចេញវេជ្ជបញ្ជា",
      "ភាពមិនបានព្យាបាល",
      "ការមិនប្រុងប្រយ័ត្នក្នុងវិធីព្យាបាលរោគ"
    ],
    correct: 3
  },
  {
    question: "ការទទួលខុសត្រូវផ្នែករដ្ឋប្បវេណីរបស់គ្រូពេទ្យ គឺគ្រូពេទ្យមិនបានទទួលការព្រមព្រៀងដោយចំ ចំពោះឬ គ្មានបានបំភ្លឺដោយគ្រប់គ្រាន់ពីអ្នកជំងឺ នេះជាកំហុស៖",
    img: "",
    responses: [
      "កំហុសនៃការព្យាបាល",
      "កំហុសចេញវេជ្ជបញ្ជា",
      "ភាពមិនបានព្យាបាល",
      "ការមិនប្រុងប្រយ័ត្នក្នុងវិធីព្យាបាលរោគ",
      "ការមិនព្រមព្រៀងពីអ្នកជំងឺ"
    ],
    correct: 4
  },
  {
    question: "ការទទួលខុសត្រូវផ្នែករដ្ឋប្បវេណីរបស់គ្រូពេទ្យ គឺគ្រូពេទ្យទទួលបានការខុស ខូចខាតបន្ទាប់ពីវិបត្តិរបស់ម៉ាស៊ីន រឺការប្រើប្រាស់របស់គាត់ នេះជាកំហុស៖",
    img: "",
    responses: [
      "កំហុសនៃការព្យាបាល",
      "កំហុសចេញវេជ្ជបញ្ជា",
      "ភាពមិនបានព្យាបាល",
      "ការប្រើប្រាស់ឧបករណ៍ និងម៉ាស៊ីន"
    ],
    correct: 3
  },
  {
    question: "ការទទួលខុសត្រូវផ្នែករដ្ឋប្បវេណីរបស់គ្រូពេទ្យ គឺគ្រូពេទ្យទទួលខុសត្រូវចំពោះកំហុសដែលកើតឡើងដោយ អ្នកជិតស្និទនឹងគ្រូពេទ្យខ្លួនឯងក្នុងប្រតិបត្តិការធ្វើវេជ្ជបញ្ជាព្យាបាល នេះជាកំហុស៖",
    img: "",
    responses: [
      "កំហុសនៃការព្យាបាល",
      "កំហុសចេញវេជ្ជបញ្ជា",
      "ភាពមិនបានព្យាបាល",
      "កំហុសនៃអ្នកជួយ"
    ],
    correct: 3
  },
  {
    question: "នៅពេលដែល ព្រមទទួលពិនិត្យព្យាបាលអ្នកជំងឺ គ្រូពេទ្យត្រូវ",
    img: "",
    responses: [
      "ត្រូវធ្វើការថែទាំដោយយកចិត្តទុកដាក់ស្មោះត្រង់ផ្អែកលើចំណេះដឹងវិទ្យាសាស្ត្រ និងបើចាំបាច់ត្រូវរកជំនួយពីអ្នកដែលមានសមត្ថភាពខ្ពស់ជាង",
      "មិនត្រូវប្រកាន់ពូជសាសន៍ សញ្ជាតិ ពណ៌សម្បូរ សាសនា",
      "មិនត្រូវប្រកាន់អំពីស្ថានភាពគ្រួសារ សេដ្ឋកិច្ច សង្គម និងនិន្នាការនយោបាយឡើយ",
      "ត្រូវធ្វើការថែទាំ និងព្យាបាលដោយយកចិត្តទុកដាក់"
    ],
    correct: 0
  },
  {
    question: "ក្នុងការប្រកបវិជ្ជាជីវៈវេជ្ជសាស្រ្តទោះក្នុងលក្ខណៈជាឯកជនក្តី ជាសាធារណៈក្តីគ្រូពេទ្យត្រូវតែ",
    img: "",
    responses: [
      "គោរពជីវិត រាង្គកាយ និង សេចក្តីថ្លៃថ្នូររបស់មនុស្ស",
      "ផ្តល់ព័ត៌មានពិតប្រាកដនានា ដែលទាក់ទងនឹងសុខភាពរបស់ពួកគេ",
      "ព្យាបាលដោយមិនចាំបាច់បង់ថវិកា",
      "មានសីលធម៌ល្អនៅអំឡុងពេលធ្វើរោគវិនិច្ឆ័យ និងពេលព្យាបាល"
    ],
    correct: 0
  },
  {
    question: "ដើម្បីផលប្រយោជន៍របស់អ្នកជំងឺ តើគ្រូពេទ្យត្រូវបំពេញអ្វីខ្លះ?",
    img: "",
    responses: [
      "រក្សាការសម្ងាត់វិជ្ជាជីវៈក្នុងល័ក្ខខ័ណ្ឌដែលបានកំណត់ដោយក្រុមគ្រួសារឬអ្នកជំងឺ",
      "រក្សាការសម្ងាត់វិជ្ជាជីវៈក្នុងល័ក្ខខ័ណ្ឌសមស្រប",
      "រក្សាការសម្ងាត់វិជ្ជាជីវៈក្នុងល័ក្ខខ័ណ្ឌដែលបានកំណត់ដោយច្បាប់",
      "ផ្តល់ព័ត៌មានដល់អ្នកជំងឺ"
    ],
    correct: 2
  },
  {
    question: "ការបូមយកឈាម ព្រមទាំងការកាត់យកសរីរាង្គ ជាលិកា កោសិកា ឬផ្នែកផ្សេងៗទៀតណាមួយ នៃរាង្គកាយទៅលើមនុស្សមានជីវិត ឬមនុស្សស្លាប់អាចធ្វើទៅបានក្នុងល័ក្ខខ័ណ្ឌដូចម្ដេច?",
    img: "",
    responses: [
      "តែក្នុងល័ក្ខខ័ណ្ឌកំណត់ដោយច្បាប់",
      "មិនចាំបាច់មានល័ក្ខខ័ណ្ឌកំណត់ដោយច្បាប់",
      "អាស្រ័យលើសិទ្ធិ របស់គ្រូពេទ្យជាអ្នកព្យាបាល",
      "ដោយមានការឯកភាពពីក្រុមគ្រួសារ"
    ],
    correct: 0
  },
  {
    question: "Examens paraclinique មួយចំនួនធំមានលក្ខណៈពិសេសដែលបច្ចេកទេសធម្មតាមិនអាចអនុវត្តទៅបាននោះទេ ដូច្នេះគ្រូពេទត្រូវប្រគល់ឱ្យការពិនិត្យនេះទៅអ្នកណា?",
    img: "",
    responses: [
      "ឱ្យការពិនិត្យនេះទៅអ្នកជំនាញ ឬអ្នកបច្ចេកទេសមន្ទីរពិសោធន៍",
      "ឱ្យការពិនិត្យនេះទៅគ្រូពេទ្យឯកទេស",
      "ឱ្យការពិនិត្យនេះទៅឱសថការី",
      "ឱ្យការពិនិត្យនេះទៅគិលានុប្បដ្ឋា-យិការ"
    ],
    correct: 0
  },
  {
    question: "ដើម្បីផលប្រយោជន៍របស់អ្នកជំងឺ គ្រូពេទ្យត្រូវទំនាក់ទំនងល្អជាមួយអ្នកណា?",
    img: "",
    responses: [
      "ជាមួយសមាជិកទាំងឡាយ នៃវិជ្ជាជីវៈសុខាភិបាល",
      "ជាមួយសមាជិកទាំងឡាយ នៃវិជ្ជាជីវៈសុខាភិបាល ដែលសមាជិកទាំងនោះត្រូវគោរពឯករាជ្យភាពវិជ្ជាជីវៈទៅវិញទៅមក និងគោរពសេរីភាពក្នុងការជ្រើសរើសរបស់អ្នកជំងឺ",
      "ជាមួយសមាជិកគ្រួសារអ្នកជំងឺ",
      "ជាមួយអ្នកមានឯកទេស ឬជំនាញខ្ពស់ជាង"
    ],
    correct: 1
  },
  {
    question: "ករណីគ្រូពេទ្យមានទំនាស់ជាមួយគ្នា តើគ្រូពេទ្យត្រូវស្វែងរកដំណោះស្រាយតាមរយៈអ្វីខ្លះ?",
    img: "",
    responses: [
      "តាមរយៈក្រុមប្រឹក្សាគណៈគ្រូពេទ្យខេត្ត ក្រុង",
      "តាមរយៈក្រុមប្រឹក្សាគណៈគ្រូពេទ្យ",
      "តាមរយៈនាយកគ្រប់គ្រង",
      "តុលាការ"
    ],
    correct: 0 // Note: Original file said "No correct answer". Defaulting to A.
  },
  {
    question: "ក្នុងការប្រកបវិជ្ជាជីវៈវេជ្ជសាស្ត្រ ទោះក្នុងលក្ខណៈជាឯកជនក្តីជាសាធារណៈក្តី គ្រូពេទ្យត្រូវតែ",
    img: "",
    responses: [
      "គោរពជីវិតរាង្គកាយ និងសេចក្តីថ្លៃថ្នូររបស់មនុស្ស",
      "រក្សាកិត្តិយស និងសេចក្តីថ្លៃថ្នូរនៃវិជ្ជាជីវៈរបស់អ្នកជម្ងឺ",
      "គោរពការសម្ងាត់វិជ្ជាជីវៈ",
      "គោរពរាប់អានជួយយកអាសារ ដល់សហភាតរៈ"
    ],
    correct: 0
  },
  {
    question: "នៅចំពោះមុខអ្នកជំងឺ ឬអ្នករបួសធ្ងន់ តើគ្រូពេទ្យត្រូវរិះរកមធ្យោដូចម្តេចដើម្បីជួយសង្គ្រោះអ្នកទាំងនោះ?",
    img: "",
    responses: [
      "គ្រូពេទ្យត្រូវធ្វើការព្យាលបន្ទាន់ បើចាំបាច់ត្រូវបញ្ជូនទៅមន្ទីរពេទ្យ",
      "ធ្វើយ៉ាងណាឱ្យអ្នកជំងឺបានធូស្រាល",
      "គ្រូពេទ្យត្រូវសង្គ្រោះអ្នកជម្ងឺ ធ្វើយ៉ាងណាឱ្យអ្នកទាំងនោះបានទទួលការថែទាំដែលចាំបាច់បំផុត",
      "គ្រូពេទ្យត្រូវសង្គ្រោះអ្នកជម្ងឺ ដោយធ្វើពលិកម្មគ្រប់បែបយ៉ាងដើម្បីមនុស្សធម៌"
    ],
    correct: 2
  },
  {
    question: "អ្នកប្រកបវិជ្ជាជីវៈវេជ្ជសាស្ត្រ និង អមវេជ្ជសាស្ត្រ គឺជា",
    img: "",
    responses: [
      "គ្រូពេទ្យ និងអ្នកបច្ចេកទេសនៅមន្ទីរពិសោធន៍",
      "គ្រូពេទ្យ ឱសថការី ទន្តពេទ្យ និងឆ្មប",
      "អ្នកប្រកបវិជ្ជាជីវៈសុខាភិបាលទាំងអស់នៅក្នុងព្រះរាជាណាចក្រកម្ពុជា",
      "គ្រូពេទ្យ និង ឱសថការី"
    ],
    correct: 1
  },
  {
    question: "អ្នកប្រកបវិជ្ជាជីវៈជំនួយវេជ្ជសាស្រ្តគឺជា",
    img: "",
    responses: [
      "គិលានុប្បដ្ឋាក ក៏លានុប្បដ្ឋាកយិកា និងអ្នកបច្ចេកទេសមន្ទីរពិសោធន៍",
      "គិលានុប្បដ្ឋាក គិលានុប្បដ្ឋាកយិកា អ្នកបច្ចេកទេសមន្ទីរពិសោធន៍ អ្នកព្យាបាលដោយចលនាបច្ចេកទេសធ្មេញ និងអ្នកបច្ចេកទេសផ្សេងទៀត",
      "អ្នកបច្ចេកទេសមន្ទីរពិសោធន៍ និងអ្នកបច្ចេកទេសផ្សេងទៀត",
      "អ្នកបច្ចេកទេសមន្ទីរពិសោធន៍"
    ],
    correct: 1
  },
  {
    question: "ចំពោះមុខអ្នកជម្ងឺ គ្រូពេទ្យត្រូវតែគិតពី",
    img: "",
    responses: [
      "ពូជសាសន៍ - សាសនា",
      "វណ្ណៈ និង ឋានៈក្នុងសង្គម",
      "កិត្តិយស និង សេចក្តីថ្លៃថ្នូរនៃវិជ្ជាជីវៈ",
      "និន្នាការនយោបាយ"
    ],
    correct: 2
  },
  {
    question: "គោរពការសម្ងាត់វិជ្ជាជីវៈ មានន័យថារក្សា",
    img: "",
    responses: [
      "ការសម្ងាត់របស់គ្រូពេទ្យ",
      "ការសម្ងាត់របស់គិលានុបដ្ឋាក-ឆ្មប",
      "ការសម្ងាត់របស់អតិថិជន ឬ អ្នកជម្ងឺ",
      "ចំលើយទាំងអស់ខាងលើពិតជាត្រឹមត្រូវ"
    ],
    correct: 2
  },
  {
    question: "កំហុសឆ្គងវិជ្ជាជីវៈសុខាភិបាល គឺសំដៅដល់កំហុសឆ្គងទាំងឡាយដែលខុសនឹង",
    img: "",
    responses: [
      "ក្រមសីលធម៌វិជ្ជាជីវៈ",
      "បទដ្ឋានវិជ្ជាជីវៈ និយាមវិជ្ជាជីវៈ",
      "ដែនកំណត់វិជ្ជាជីវៈសុខាភិបាល ដោយអ្នកប្រកមវិជ្ជាជីវៈសុខាភិបាល",
      "ចំលើយទាំងអស់ខាងលើពិតជាត្រឹមត្រូវ"
    ],
    correct: 3
  },
  {
    question: "គោលចំបងរបសវេជ្ជសាស្ត្រ គឺ៖",
    img: "",
    responses: [
      "មនុស្ស",
      "សាសនា",
      "ប្រាក់កាស",
      "ពូជសាសន៍"
    ],
    correct: 0
  },
  {
    question: "វេជ្ជសាស្រ្តបូរាណចិនដែលនៅអនុវត្តន៍ គឺ៖",
    img: "",
    responses: [
      "វះកាត់",
      "ម្ជុលវិទ្យាសាស្ត្រ",
      "ចាក់ថ្នាំ",
      "ស្តោះផ្លុំ"
    ],
    correct: 1
  },
  {
    question: "ការរីកសាយវេជ្ជសាស្ត្រ នៅ ស.វ ទី ១៥- ១៦ ៖",
    img: "",
    responses: [
      "ជោគជយ័នៃសង្គ្រាម",
      "ការរកឃើញពុម្ពអក្សរ",
      "ការរកឃើញដីថ្មី",
      "ការរីកសាយនៃវិធីព្យាបាលដោយចលនា"
    ],
    correct: 1
  },
  {
    question: "សំណាក់មន្ទីរពិសោធន៍ ដែលនៅប្រើប្រាស់រហូតដល់សព្វថ្ងៃ",
    img: "",
    responses: [
      "ឈាម",
      "ទឹកនោម",
      "ខ្ទុះ",
      "ស្លេស្ម"
    ],
    correct: 0
  },
  {
    question: "ចុះហត្ថលេខាដោយសម្តេចតេជោ ហ៊ុន សែន នៅឆ្នាំណា",
    img: "",
    responses: [
      "1993",
      "2000",
      "2003",
      "2013"
    ],
    correct: 2
  },
  {
    question: "មានប៉ុន្មាន ជំពូក-មាត្រា?",
    img: "",
    responses: [
      "10 ជំពូក - 100 មាត្រា",
      "6 ជំពូក - 111 មាត្រា",
      "6 ជំពូក - 16 មាត្រា",
      "12 ជំពូក - 24 មាត្រា"
    ],
    correct: 1
  },
  {
    question: "ករណីយកិច្ចចាំបាច់ជាចំបងរបស់គ្រូពេទ្យគឺអ្វី? (ចំលើយមួយត្រឹមត្រូវ)",
    img: "",
    responses: [
      "សង្គ្រោះជីវិតមនុស្ស",
      "ស្រឡាញ់គោរពជីវិតមនុស្ស",
      "ពិនិត្យព្យាបាលសង្គ្រោះថែទាំសុខភាពរបស់មនុស្ស",
      "ព្យាបាលដោយសមភាព"
    ],
    correct: 2
  },
  {
    question: "ដូចម្តេចជាការព្យាបាលដោយមនសិការសម្បជញ្ញៈវិជ្ជាជីវៈ? (ចំលើយមួយដែលខុស)",
    img: "",
    responses: [
      "គោរពស្រឡាញ់ជីវិតរូបកាយសេចក្តីថ្លៃថ្នូររបស់មនុស្ស",
      "ព្យាបាលតាមបច្ចេកទេសវេជ្ជសាស្ត្រត្រឹមត្រូវ",
      "ផ្តល់សេវាព្យាបាលដោយស្មើភាពមិនរើសអើង",
      "ព្យាបាលដោយឈរលើមនោសញ្ចេតនារាប់អាន"
    ],
    correct: 3
  },
  {
    question: "ក្នុងពេលពិនិត្យព្យាបាលអ្នកជម្ងឺគ្រូពេទ្យត្រូវគោរពអ្វីពាក់ព័ន្ធ និង អ្នកជម្ងឺ? (ចំលើយមួយត្រឹមត្រូវ)",
    img: "",
    responses: [
      "បច្ចេកទេសវេជ្ជសាស្ត្រត្រឹមត្រូវ",
      "សំណូមពរ និង ឆន្ទៈរបស់អ្នកជម្ងឺតាមបច្ចេកទេស",
      "គោរពតួនាទីរបស់អ្នកជម្ងឺ",
      "មនោសញ្ចេតនារាប់អាន"
    ],
    correct: 1
  },
  {
    question: "ក្នុងការរស់នៅគ្រូពេទ្យត្រូវប្រាកដលើអ្វីខ្លះ? (ចំលើយមួយដែលខុស)",
    img: "",
    responses: [
      "ការនិយាយស្តីអាកប្បកិរិយា ការស្លៀកពាក់",
      "ចូលរួមរក្សាអនាម័យឧស្សាហ៍ព្យាយាម",
      "ទប់ស្កាត់ជម្ងឺរាតត្បាតផ្សេងៗ",
      "លើជំនាញបច្ចេកទេសមួយមុខគត់"
    ],
    correct: 3
  },
  {
    question: "ក្នុងការព្យាបាលអ្នកជម្ងឺអ្វីជាប្រការដែលគ្រូពេទ្យត្រូវជៀសវាង? (ចំលើយមួយត្រឹមត្រូវ)",
    img: "",
    responses: [
      "ព្យាបាលតាមគំនិតផ្ទាល់របស់ខ្លួន និង អត្តនោម័ត",
      "ព្យាបាលដោយសកម្មភាពសកម្មសង្គ្រោះមិនរើសអើង",
      "ព្យាបាលតាមបច្ចេកទេសវេជ្ជសាស្ត្រត្រឹមត្រូវ",
      "គោរពតាមសំណូមពរ និង ឆន្ទៈសមស្របរបស់អ្នកជម្ងឺ"
    ],
    correct: 0
  },
  {
    question: "មុនផ្តើមការព្យាបាលតើគ្រូពេទ្យត្រូវគិតអ្វីជាបឋម? (ចំលើយមួយត្រឹមត្រូវ)",
    img: "",
    responses: [
      "រោគសញ្ញានៃជម្ងឺ",
      "បែបបទសាកសួរជម្ងឺ",
      "សុវត្ថិភាពអាយុជីវិតរូបកាយអ្នកជម្ងឺ",
      "រោគវិនិច្ឆ័យនៃជម្ងឺ"
    ],
    correct: 2
  },
  {
    question: "ក្នុងករណីបន្ទាន់តើគ្រូពេទ្យធ្វើអ្វី? និងផ្តោតលើអ្វីជាសំខាន់? (ចំលើយត្រូវតែមួយ)",
    img: "",
    responses: [
      "ត្រូវព្យាបាលដោយយកចិត្តទុកដាក់",
      "ត្រូវសកម្មក្នុងការសង្គ្រោះអាយុជីវិតអ្នកជម្ងឺ",
      "ពិនិត្យវិភាគរករោគវិនិច្ឆ័យ",
      "ដោះស្រាយព្យាបាលតាមជំនាញ"
    ],
    correct: 1
  },
  {
    question: "ដូចម្តេចហៅថាការព្យាបាលដោយមនសិការវិជ្ជាជីវៈរបស់គ្រូពេទ្យ? (ចំលើយខុសតែមួយ)",
    img: "",
    responses: [
      "គោរពជីវិតរូបកាយសេចក្តីថ្លៃថ្នូររបស់មនុស្ស",
      "ព្យាបាលដោយស្មើភាពមិនរើសអើង",
      "ព្យាបាលដោយអត្តនោម័តតាមគំនិតផ្ទាល់ និង ផលប្រយោជន៍ផ្ទាល់ខ្លួន",
      "ព្យាបាលតាមបច្ចេកទេសវេជ្ជសាស្ត្រត្រឹមត្រូវ"
    ],
    correct: 2
  },
  {
    question: "ក្នុងការសំរេចទទួលព្យាបាលអ្នកជម្ងឺណាម្នាក់តើគ្រូពេទ្យត្រូវគិតដូចម្តេច? (ចំលើយមួយត្រូវ)",
    img: "",
    responses: [
      "ព្យាបាលយកចិត្តទុកដាក់រហូតដល់ជាសះស្បើយតាមគ្រប់មធ្យោបាយ",
      "ព្យាបាលតាមជាក់ស្តែង",
      "ព្យាបាលតាមកំរិតសមត្ថភាពផ្ទាល់ខ្លួន",
      "ព្យាបាលដោយកំណត់អ្នកជម្ងឺ"
    ],
    correct: 0
  },
  {
    question: "ក្នុងការទៅពិនិត្យអ្នកជម្ងឺដល់គេហដ្ឋានតើគ្រូពេទ្យមានតួនាទី និង ភារកិច្ចដូចម្តេច? (ចំលើយមួយត្រូវ)",
    img: "",
    responses: [
      "ត្រូវពិនិត្យពីស្ថានភាពទីកន្លែងឲ្យបានច្បាស់",
      "យកចិត្តទុកដាក់លើបញ្ហាផ្សេងៗដែលកើតមាននៅទីនោះ",
      "ជួយដោះស្រាយបញ្ហាជំលោះដែលមាននៅទីនោះ",
      "ត្រូវគិត និង យកចិត្តទុកដាក់តែលើការពិនិត្យ និង ព្យាបាលជម្ងឺ"
    ],
    correct: 3
  },
  {
    question: "ដូចម្តេចហៅថាសេចក្តីថ្លៃថ្នូររបស់គ្រូពេទ្យ? (ចំលើយមួយខុស)",
    img: "",
    responses: [
      "អាកប្បកិរិយាសុភាពរាបសារ",
      "មានសុជីវធម៌ ការរស់នៅ និង អនាម័យល្អ",
      "មានមោទនភាព អំនួត និង ផលប្រយោជន៍ផ្ទាល់ខ្លួន",
      "នៅឆ្ងាយពីអំពើពាលាអាវ៉ាសែ"
    ],
    correct: 2
  },
  {
    question: "គ្រូពេទ្យត្រូវធ្វើដូចម្តេចដើម្បីការពារសេចក្តីថ្លៃថ្នូររបស់ខ្លួន? (ចំលើយមួយត្រូវ)",
    img: "",
    responses: [
      "រកកំរៃពីវិជ្ជាជីវៈឲ្យបានច្រើនតាមគ្រប់មធ្យោបាយ",
      "មានសីលធម៌រស់នៅការងារអត្តចរិកល្អសំរាប់មនុស្ស",
      "អួតក្អេងក្អាងលើកដំកើងខ្លួនឯងដោយផ្ទុយពីគោលការណ៍វិជ្ជាជីវៈ",
      "ការស្លៀកពាក់ និង ការនិយាយស្តីមិនសមរម្យ"
    ],
    correct: 1
  },
  {
    question: "គ្រូពេទ្យមានសេចក្តីថ្លៃថ្នូរ? (ចំលើយមួយមិនត្រឹមត្រូវ)",
    img: "",
    responses: [
      "គ្រូពេទ្យមានសមត្ថភាពបច្ចេកទេសត្រឹមត្រូវ",
      "គ្រូពេទ្យមានក្រមសីលធម៌សុជីវធម៍ការរស់នៅល្អ",
      "គ្រូពេទ្យមានភាពហ៊ឺហារកផលប្រយោជន៍ផ្ទាល់ខ្លួនតាមគ្រប់រូបភាព",
      "គ្រូពេទ្យខិតខំរៀនសូត្រលើកកំពស់សមត្ថភាពព្យាបាលដើម្បីមនុស្ស"
    ],
    correct: 2
  },
  {
    question: "ដូចម្តេចជាសមត្ថភាពរបស់គ្រូពេទ្យ? (ចំលើយមួយត្រឹមត្រូវ)",
    img: "",
    responses: [
      "មានសញ្ញាប័ត្រក្រោយបញ្ចប់ការសិក្សានៅសកលវិទ្យាល័យ",
      "មានការទទួលស្គាល់ពីក្រសួងសុខាភិបាល",
      "មានចំណេះដឹងក្នុងការពិនិត្យព្យាបាលជម្ងឺ",
      "មានភាពថ្នឹកជំនាញការអនុវត្តវិក្រិតការធ្វើរោគវិនិច្ឆ័យ និង ព្យាបាលមានប្រសិទ្ធិភាព"
    ],
    correct: 3
  },
  {
    question: "អ្វីជាលក្ខណៈសម្បត្តិរបស់គ្រូពេទ្យដែលត្រូវមានសំរាប់ការពិនិត្យ និង ព្យាបាលជម្ងឺ? (ចំលើយមួយត្រូវ)",
    img: "",
    responses: [
      "សេចក្តីថ្លៃថ្នូរ",
      "កំហុសគ្រូពេទ្យ",
      "ការព្យាករណ៍",
      "គុណភាព និង សមត្ថភាព"
    ],
    correct: 3
  },
  {
    question: "តើកំហុសគ្រូពេទ្យមានលក្ខណៈដូចម្តេច? (ចំលើយមួយត្រូវ)",
    img: "",
    responses: [
      "មានលក្ខណៈសង្គម",
      "មានលក្ខណៈច្បាប់ព្រហ្មទណ្ឌ",
      "មានលក្ខណៈដូចមនុស្សទូទៅ",
      "មានលក្ខណៈវិជ្ជាជីវៈវេជ្ជសាស្ត្រ"
    ],
    correct: 3
  },
  {
    question: "ការទទួលខុសត្រូវរបស់គ្រូពេទ្យដូចម្តេចចំពោះកំហុស? (ចំលើយមួយខុស)",
    img: "",
    responses: [
      "ទទួលកំហុសតែមុខវិជ្ជាជីវៈវេជ្ជសាស្ត្រ",
      "ទទួលកំហុសវិជ្ជាជីវៈតាមកំរិតខុស",
      "ទទួលកំហុសចំពោះច្បាប់ដូចមនុស្សទូទៅ",
      "កំហុសព្រហ្មទណ្ឌត្រូវទទួលតាមច្បាប់ព្រហ្មទណ្ឌ"
    ],
    correct: 0
  },
  {
    question: "នៅក្នុងការព្យាបាលអ្នកជំងឺក្រោយបញ្ចប់ការសិក្សាពីសកលវិទ្យាល័យ តើលក្ខណៈសម្បត្តិរបស់គ្រូពេទ្យខុសគ្នាត្រង់ណា? (ចំលើយមួយត្រឹមត្រូវ)",
    img: "",
    responses: [
      "សញ្ញាប័ត្រ ឬ គុណភាព",
      "សេចក្តីថ្លៃថ្នូរ",
      "សមត្ថភាព",
      "ពន្យាករណ៍"
    ],
    correct: 2
  },
  {
    question: "តើការស្មោះត្រង់ក្នុងវិជ្ជាជីវៈគ្រូពេទ្យសំដៅលើអ្វី? (ចំលើយមួយត្រឹមត្រូវ)",
    img: "",
    responses: [
      "មនសិការវិជ្ជាជីវៈត្រឹមត្រូវ",
      "ការងារប្រចាំថ្ងៃ",
      "ការដាក់ខ្លួនជាមួយអ្នកជំងឺ",
      "ការយកចិត្តទុកដាក់ថែទាំអ្នកជំងឺ"
    ],
    correct: 0
  },
  {
    question: "ក្នុងការការព្យាករណ៍ស្ថានភាពជំងឺគ្រូពេទ្យត្រូវធ្វើយ៉ាងដូចម្តេច? (ចំលើយមួយត្រូវ)",
    img: "",
    responses: [
      "ព្យាករណ៍ស្រាលៗតាមសំណូមពរគ្រួសារអ្នកជំងឺ",
      "ព្យាករណ៍លើសភាពជាក់ស្តែង",
      "ព្យាករណ៍ដោយមិនបានស្វែងយល់ពីដំណើរវិវត្តន៍នៃជំងឺ",
      "ពិចារណា ឈ្លាសវៃ ថាតើគួរឬមិនគួរ ព្យាករណ៍លើការវិវត្តន៍នៃជំងឺ"
    ],
    correct: 3
  },
  {
    question: "ដូចម្តេចដែលថាវេជ្ជសាស្ត្រជាពាណិជ្ជកម្ម? (ចំលើយមួយខុស)",
    img: "",
    responses: [
      "ផ្សព្វផ្សាយការព្យាបាលតាមរូបភាពពាណិជ្ជកម្ម",
      "ប្រកួតប្រជែងដណ្តើមអតិថិជនគ្នា",
      "ដើរព្យាបាលឃោសនាអូសទាញអតិថិជន",
      "មានទីតាំងពិនិត្យព្យាបាលមានច្បាប់អនុញ្ញាតិត្រឹមត្រូវ"
    ],
    correct: 3
  },
  {
    question: "វេជ្ជសាស្ត្រមិនមែនពាណិជ្ជកម្មគឺ? (ចំលើយមួយខុស)",
    img: "",
    responses: [
      "គ្រូពេទ្យសហការគ្នាដើម្បីព្យាបាលអ្នកជំងឺ",
      "គ្រូពេទ្យចេះស្រលាញ់គ្នាដូចបងប្អូន",
      "មានអំនួតឃោសនាអូសទាញអ្នកជំងឺ",
      "គ្រូពេទ្យ និង គ្រូពេទ្យមិនបន្តុះបង្អាប់គ្នាដើម្បីផលប្រយោជន៍ផ្ទាល់ខ្លួន"
    ],
    correct: 2
  },
  {
    question: "គ្រូពេទ្យធ្វើយ៉ាងដូចម្តេចដើម្បីកុំឲ្យវេជ្ជសាស្ត្រជាពាណិជ្ជកម្ម? (ចំលើយមួយខុស)",
    img: "",
    responses: [
      "ជៀសវាងការផ្សព្វផ្សាយជាពាណិជ្ជកម្ម",
      "ជៀសវាងដណ្តើមអតិថិជនគ្នា",
      "ជៀសវាងព្យាបាលចល័ត",
      "អូសទាញអតិថិជនពីមន្ទីរពេទ្យទៅផ្ទះរបស់ខ្លួន"
    ],
    correct: 3
  },
  {
    question: "ដូចម្តេចជាលាក់ការណ៏វេជ្ជសាស្ត្រ? (ចំលើយមួយត្រឹមត្រូវ)",
    img: "",
    responses: [
      "លាក់ការណ៏មួយជាកំណត់ទាក់ទង និង វេជ្ជសាស្ត្រ",
      "លាក់ការណ៏របស់មនុស្ស",
      "លាក់ការណ៏ប្រចាំថ្ងៃរបស់គ្រូពេទ្យ",
      "លាក់ការណ៏ផ្ទាល់ខ្លួនរបស់អ្នកជំងឺ"
    ],
    correct: 0
  },
  {
    question: "អ្វីជាចរិយាសាស្រ្តរបស់លាក់ការណ៏វេជ្ជសាស្ត្រ? (ចំលើយមួយត្រឹមត្រូវ)",
    img: "",
    responses: [
      "អ្នកជំងឺត្រូវលាក់ការណ៏ដាច់ខាត",
      "ចរិយាសាស្រ្តរបស់មនុស្សលោកផងជាច្បាប់ផង",
      "គ្រូពេទ្យត្រូវតែចេញលាក់ការណ៏ដែលអ្នកជំងឺប្រាប់",
      "អ្នកជំងឺមិនចាំបាច់ប្រាប់បញ្ហារបស់ខ្លួនដល់គ្រូពេទ្យទេ"
    ],
    correct: 1
  },
  {
    question: "លាក់ការណ៏វេជ្ជសាស្ត្រមានចរិកដូចម្តេច? (ចំលើយមួយខុស)",
    img: "",
    responses: [
      "ចរិកដាច់ខាត",
      "ចរិកជាកិច្ចសន្យា",
      "ចរិកសេរី",
      "ចរិកធម្មជាតិ"
    ],
    correct: 0
  },
  {
    question: "ក្នុងលាក់ការណ៏វេជ្ជសាស្ត្រមានបច្ច័យអ្វីខ្លះ? (ចំលើយមួយខុស)",
    img: "",
    responses: [
      "លាក់ការណ៏បានត្រូវអ្នកជម្ងឺគោរពរាប់អាន",
      "លាក់ការណ៏មិនបានត្រូវអ្នកជម្ងឺចោទប្រកាន់",
      "ជាបច្ច័យល្អគ្រូពេទ្យត្រូវអនុវត្តលាក់ការណ៏ឲ្យបាន",
      "ការលាក់ការណ៏របស់គ្រូពេទ្យមិនមានបច្ច័យក្នុងកិច្ចការប្រចាំថ្ងៃទេ"
    ],
    correct: 3
  },
  {
    question: "ដូចម្តេចជាម្ចាស់នៃលាក់ការណ៏វេជ្ជសាស្ត្រ? (ចំលើយមួយត្រឹមត្រូវ)",
    img: "",
    responses: [
      "គ្រប់គ្រងលាក់ការណ៏វេជ្ជសាស្ត្រ",
      "ចាត់ចែងបណ្តាលាក់ការណ៏វេជ្ជសាស្ត្រ",
      "សំរេចលើលាក់ការណ៏វេជ្ជសាស្ត្រ",
      "ទាំងបីខាងលើខុស"
    ],
    correct: 3
  },
  {
    question: "អ្នកណាខ្លះជាម្ចាស់នៃលាក់ការណ៏វេជ្ជសាស្ត្រ? (ចំលើយមួយត្រឹមត្រូវ)",
    img: "",
    responses: [
      "គ្រូពេទ្យ",
      "អ្នកជំងឺ",
      "គ្រូពេទ្យ និង អ្នកជំងឺ",
      "ផ្នែកដោះស្រាយផ្លូវច្បាប់ (តុលាការ)"
    ],
    correct: 2
  },
  {
    question: "បដិប្បញ្ញត្តិ (La dérogation) ជាអ្វី? ទាក់ទងនឹងលាក់ការណ៏វេជ្ជសាស្ត្រ? (ចំលើយមួយត្រឹមត្រូវ)",
    img: "",
    responses: [
      "អ្វីៗផ្ទុយពីអាថ៌កំបាំងវេជ្ជសាស្ត្រ",
      "រាល់លាក់ការណ៏វេជ្ជសាស្ត្រទាំងអស់ត្រូវបង្ហាញ",
      "រាល់លាក់ការណ៏វេជ្ជសាស្ត្រដែលត្រូវបង្ហាញដោយផ្អែកលើច្បាប់",
      "រាល់ការបង្ហាញលាក់ការណ៏វេជ្ជសាស្ត្រត្រូវហាមឃាត់"
    ],
    correct: 2
  }

    ],
    memoriesList: [], // Stores indices of questions from the main bank
    testQuestions: [],
    answers: [],
    currentTestConfig: {},
    idx: 0,
    quizTitle: "Multiple Choice Question Preparation",
    editIdx: -1,
    editQ: null,
    isMuted: true,
    dark: window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches,
    timerId: null,
  };
}
let state = getDefaultState();

// --- Utility & Data Functions ---
function saveData() {
  localStorage.setItem(MEMORY_LIST_KEY, JSON.stringify(state.memoriesList));
}
function loadData() {
  try {
    const memoryData = JSON.parse(localStorage.getItem(MEMORY_LIST_KEY));
    if (memoryData && Array.isArray(memoryData)) {
        state.memoriesList = memoryData.filter(index =>
            index >= 0 && index < state.mainQuestionBank.length
        );
    }

    const settings = JSON.parse(localStorage.getItem(SETTINGS_KEY));
    if (settings) {
        state.dark = settings.dark || false;
        state.isMuted = settings.isMuted === undefined ? true : settings.isMuted;
    }
  } catch (e) {
    console.error("Failed to load data from localStorage", e);
  }
}
function saveSettings() {
    localStorage.setItem(SETTINGS_KEY, JSON.stringify({ dark: state.dark, isMuted: state.isMuted }));
}
function shuffle(arr) {
  const a = arr.slice();
  for(let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function escapeHtml(str) {
    if (typeof str !== 'string') return '';
    const brPlaceholder = '___BR___';
    let tempStr = str.replace(/<br\s*\/?>/gi, brPlaceholder);
    tempStr = tempStr.replace(/[&<>"']/g, t => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[t]));
    return tempStr.replace(new RegExp(brPlaceholder, 'g'), '<br>');
}
function getScoreRemark(score) {
  if (score === 100) return "Perfect Score! You are a genius! 🧠";
  if (score >= 90) return "Excellent work! You really know your stuff. ✨";
  if (score >= 80) return "Great job! Very impressive. 👍";
  if (score >= 70) return "Good score! Keep up the good work. 😊";
  if (score >= 50) return "Not bad, but there's room for improvement. Keep studying! 📚";
  if (score >= 30) return "You've got the basics, but review is needed. Don't give up! 💪";
  return "This was a tough one. Review your mistakes and try again! 🤔";
}

// ---  Controls ---
function setupAudio() {
    const audio = document.getElementById('bg-music');
    if (!audio) return;
    audio.src = "background_music.mp3"; 
    audio.muted = state.isMuted;
    if (!state.isMuted) {
      audio.play().catch(e => console.log("Autoplay was prevented."));
    }
}
window.toggleMute = function() {
    state.isMuted = !state.isMuted;
    const audio = document.getElementById('bg-music');
    if (audio) {
      audio.muted = state.isMuted;
      if (!state.isMuted) {
          audio.play().catch(e => console.log("Could not play audio."));
      } else {
          audio.pause();
      }
    }
    saveSettings();
    const muteIcons = document.querySelectorAll('.icon-btn[onclick="toggleMute()"]');
    muteIcons.forEach(icon => {
        icon.innerHTML = state.isMuted ? '🔇' : '🔊';
    });
}
window.toggleDarkMode = function() {
    state.dark = !state.dark;
    saveSettings();
    document.body.classList.toggle('dark', state.dark);
    const darkModeIcons = document.querySelectorAll('.icon-btn[onclick="toggleDarkMode()"]');
    darkModeIcons.forEach(icon => {
        icon.innerHTML = state.dark ? "☀️" : "🌙";
    });
}

// --- Core Rendering Engine ---
function render() {
  document.body.className = state.dark ? "dark" : "";
  const app = document.getElementById("app");
  app.innerHTML = ''; 

  switch (state.view) {
    case "menu": renderMenu(app); break;
    case "view_bank": renderViewBank(app); break;
    case "memories_list": renderMemoriesList(app); break;
    case "study_setup": renderRangeSetup(app, 'study'); break;
    case "study_test": renderFullTest(app); break;
    case "test_setup": renderRangeSetup(app, 'test'); break;
    case "test_test": renderFullTest(app); break;
    case "sixty_setup": renderSixtySetup(app); break;
    case "paged_test": renderPagedTest(app); break;
    case "timelimit_setup": renderTimeLimitSetup(app); break;
    case "memories_setup": renderMemoriesSetup(app); break;
    case "results": renderResults(app); break;
    case "instruction": renderInstruction(app); break;
    case "edit_question": renderEdit(app); break;
    case "moodle_test": renderMoodleTest(app); break;
    default: app.innerHTML = "<h2>Unknown Page</h2>"; break;
  }
}
function renderHeader(title) {
    return `
    <div class="global-header">
      <button class="btn-secondary" onclick="setView('menu')">‹ Back to Main Menu</button>
      <div class="header-icons">
        <button class="icon-btn" onclick="toggleMute()">${state.isMuted ? '🔇' : '🔊'}</button>
        <button class="icon-btn" onclick="toggleDarkMode()">${state.dark ? "☀️" : "🌙"}</button>
      </div>
    </div>
    <h1>${escapeHtml(title)}</h1>
  `;
}

// --- View-Specific Renderers ---
function renderMenu(app) {
 app.innerHTML = `
    <div class="global-header">
      <h1 style="margin: 0;" contenteditable="true" onblur="updateTitle(this)">${escapeHtml(state.quizTitle)}</h1>
      <div class="header-icons">
        <button class="icon-btn" onclick="toggleMute()">${state.isMuted ? '🔇' : '🔊'}</button>
        <button class="icon-btn" onclick="toggleDarkMode()">${state.dark ? "☀️" : "🌙"}</button>
      </div>
    </div>
    <p>Number of Questions in the Main Bank: <b>${state.mainQuestionBank.length} Questions</b></p>
    <div class="main-menu">
      <div class="menu-button" onclick="setView('study_setup')"><span class="menu-icon">📖</span>Study Question</div>
      <div class="menu-button" onclick="setView('test_setup')"><span class="menu-icon">📝</span>Test Question</div>
      <div class="menu-button" onclick="setView('moodle_test')"><span class="menu-icon">🏫</span>Moodle Test</div>
      <div class="menu-button" onclick="setView('sixty_setup')"><span class="menu-icon">⏱️</span>60/60 Test</div>
      <div class="menu-button" onclick="setView('timelimit_setup')"><span class="menu-icon">⏳</span>Time Limit Test</div>
      <div class="menu-button" onclick="setView('memories_setup')"><span class="menu-icon">🎯</span>Memories Test</div>
      <div class="menu-button" onclick="setView('memories_list')"><span class="menu-icon">🧠</span>Memories List</div>
      <div class="menu-button" onclick="setView('view_bank')"><span class="menu-icon">🏦</span>View Bank</div>
      <div class="menu-button" onclick="setView('instruction')"><span class="menu-icon">ℹ️</span>Instruction</div>
    </div>
    <div class="notes-section" style="margin-top:20px; font-size: 0.9em; opacity: 0.8;">
      <p><b>Notice:</b> Before starting the quiz, Please allow Third party cookie for the site. Editing Question Bank: won't saved into the file.</p>
      <p><b>Important Notice:</b> If the memories List is Broken, Please clear question In Memories List. If There is any persist, Clear your Browsing data and if there is any mistake in question bank or More info, please contact me on Telegram : <a href="https://t.me/multiplequestion" target="_blank" style="color: var(--primary);">https://t.me/multiplequestion</a>.</p>
    </div>
  `;
}
function renderViewBank(app) {
    app.innerHTML = `
        ${renderHeader("Main Question Bank")}
        <button onclick="addNewQuestion()">Add New Question</button>
        <div class="manage-list" style="margin-top: 20px;">
          ${state.mainQuestionBank.map((q, i) => renderManageQuestion(q, i, true)).join('')}
        </div>
    `;
}
function renderManageQuestion(q, index, isMainBankView) {
    const originalIndex = isMainBankView ? index : state.memoriesList[index];
    const questionData = state.mainQuestionBank[originalIndex];
    if (!questionData) return '';

    return `
    <div class="question-card">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div style="font-weight:bold;">Q${originalIndex + 1}: ${escapeHtml(questionData.question)}</div>
        <div class="manage-actions" style="display: flex; gap: 5px; flex-shrink: 0; margin-left: 10px;">
          <button onclick="editQuestion(${originalIndex})">Edit</button>
          <button class="btn-danger" onclick="${isMainBankView ? `deleteQuestion(${originalIndex})` : `deleteFromMemory(${index})`}">Delete</button>
        </div>
      </div>
      ${questionData.img ? `<img src="${questionData.img}" class="question-img" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">` : ""}
      <ol type="A" style="margin:12px 0 0 20px; padding-left: 0;">
        ${questionData.responses.map((r, j) => `
          <li style="padding: 4px 0; ${j === questionData.correct ? 'font-weight:600; color:var(--correct);' : ''}">
            ${escapeHtml(r)}
          </li>`).join('')}
      </ol>
    </div>
  `;
}
function renderMemoriesList(app) {
    let content = `
        ${renderHeader("Memories List")}
        <div style="background-color: var(--light-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; text-align: center; margin-bottom: 20px;">
            <h3 style="margin: 0; font-size: 1.2em; color: var(--text);">Total Questions in Memories: <span style="color: var(--primary); font-weight: bold; font-size: 1.5em;">${state.memoriesList.length}</span></h3>
        </div>
        <div class="setup-form">
            <div class="form-group">
                <label for="add-mem-input">Add questions from Main Bank by number (e.g., "45, 52, 60-70"):</label>
                <input type="text" id="add-mem-input" placeholder="Enter numbers or ranges...">
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="addQuestionsToMemory()">Add to List</button>
                <button class="btn-danger" onclick="clearMemories()">Clear All Questions</button>
            </div>
        </div>
        <div class="manage-list" style="margin-top: 20px;">
    `;
    if (state.memoriesList.length === 0) {
        content += `<p>Your memories list is empty. Incorrectly answered questions from tests will appear here.</p>`;
    } else {
        content += state.memoriesList.map((qIndex, i) => renderManageQuestion(null, i, false)).join('');
    }
    content += `</div>`;
    app.innerHTML = content;
}
function renderRangeSetup(app, mode) {
    const title = mode === 'study' ? 'Study Question Setup' : 'Test Question Setup';
    app.innerHTML = `
        ${renderHeader(title)}
        <div class="setup-card">
            <p>Select the questions you want to practice.</p>
            <div class="range-group">
                <label>From</label>
                <input type="number" class="range-from" min="1" max="${state.mainQuestionBank.length}" placeholder="1">
                <label>To</label>
                <input type="number" class="range-to" min="1" max="${state.mainQuestionBank.length}" placeholder="${state.mainQuestionBank.length}">
            </div>
            <div class="button-group">
                <button onclick="startTestFromRange('${mode}')">Start ${mode === 'study' ? 'Study' : 'Test'}</button>
                <button class="btn-secondary" onclick="startTestFromRange('${mode}', true)">${mode === 'study' ? 'Study' : 'Test'} Whole Bank</button>
            </div>
        </div>
    `;
}
function renderFullTest(app) {
    const { mode } = state.currentTestConfig;
    app.innerHTML = `
        ${renderHeader(mode === 'study' ? 'Study Session' : 'Test Session')}
        <div id="full-test-container">
            ${state.testQuestions.map((q, i) => renderFullTestQuestion(q, i, mode)).join('')}
        </div>
        <button onclick="finishAttempt()" style="margin-top: 20px; width: 100%; padding: 15px; font-size: 1.2em;">Finish Attempt</button>
    `;
}
function renderFullTestQuestion(q, index, mode) {
    const answer = state.answers[index];
    const isAnswered = answer !== undefined;

    return `
    <div class="question-card" id="q-card-${index}">
      <h3 style="font-weight:bold;">
        ${mode === 'study' ? `Q${q.originalIndex + 1}: ` : ''}${escapeHtml(q.question)}
      </h3>
      ${q.img ? `<img src="${q.img}" class="question-img" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">` : ''}
      <div class="responses">
        ${q.shuffledResponses.map((r, j) => {
            const isCorrect = q.shuffledMap[j] === q.correct;
            const isSelected = j === answer;
            let cls = 'response-box';
            if (isAnswered) {
                if (isSelected && isCorrect) cls += ' correct';
                else if (isSelected && !isCorrect) cls += ' wrong';
                else if (isCorrect) cls += ' correct';
            }
            return `
            <div class="${cls}" onclick="handleImmediateFeedback(${index}, ${j})">
              <span class="response-prefix">${String.fromCharCode(65 + j)})</span>
              <span>${escapeHtml(r)}</span>
            </div>`;
        }).join('')}
      </div>
    </div>
    `;
}
function renderSixtySetup(app) {
    app.innerHTML = `
        ${renderHeader("60/60 Test Setup")}
        <div class="setup-card">
            <p>Select the difficulty level for the test.</p>
            <div class="form-group">
                <label for="difficulty">Time Limit per Question:</label>
                <select id="difficulty">
                    <option value="60">Normal (60s / Q)</option>
                    <option value="45">Lag lag lag (45s / Q)</option>
                    <option value="30">Why so slow? (30s / Q)</option>
                    <option value="20">Stuck n Suprise (20s / Q)</option>
                    <option value="15">I will send to Jesus (15s / Q)</option>
                    <option value="10">Asian diff (10s / Q)</option>
                </select>
            </div>
            <div class="button-group">
                <button onclick="startPagedTest('sixty')" ${state.mainQuestionBank.length < 60 ? 'disabled' : ''}>
                  Start 60/60 Test
                </button>
            </div>
            ${state.mainQuestionBank.length < 60 ? `<p style="color:var(--error); margin-top: 15px;">You need at least 60 questions in the main bank to start this mode.</p>` : ''}
        </div>
    `;
}
function renderTimeLimitSetup(app) {
    app.innerHTML = `
        ${renderHeader("Time Limit Test Setup")}
        <div class="setup-card">
            <p>Define the question range and time limit.</p>
            <div class="form-grid">
                <div class="form-group range-group">
                    <label>From</label>
                    <input type="number" id="range-from" min="1" max="${state.mainQuestionBank.length}" value="1">
                    <label>To</label>
                    <input type="number" id="range-to" min="1" max="${state.mainQuestionBank.length}" value="${state.mainQuestionBank.length}">
                </div>
                <div class="form-group">
                    <label for="time-limit">Time per question (sec):</label>
                    <input type="number" id="time-limit" min="5" value="30">
                </div>
            </div>
            <div class="button-group">
                <button onclick="startPagedTest('timelimit')">Start Time Limit Test</button>
                <button class="btn-secondary" onclick="startPagedTest('timelimit', true)">Test Whole Bank</button>
            </div>
        </div>
    `;
}
function renderMemoriesSetup(app) {
    app.innerHTML = `
        ${renderHeader("Memories Test Setup")}
        <div class="setup-card">
             <p>Configure your targeted practice session.</p>
            <div class="form-grid">
                 <div class="form-group">
                    <label>Test Mode:</label>
                    <select id="mem-test-mode">
                        <option value="memory_only">Only Questions from Memories List (${state.memoriesList.length} questions)</option>
                        <option value="memory_plus">Memories List + Random from Main Bank</option>
                    </select>
                </div>
                <div class="form-group" id="extra-questions-group" style="display:none;">
                    <label for="extra-questions">Random questions to add:</label>
                    <input type="number" id="extra-questions" min="1" value="10" max="${state.mainQuestionBank.length - state.memoriesList.length}">
                </div>
            </div>
            <div class="button-group">
                <button onclick="startPagedTest('memory')" ${state.memoriesList.length === 0 ? 'disabled' : ''}>Start Memories Test</button>
            </div>
             ${state.memoriesList.length === 0 ? `<p style="color:var(--error); margin-top: 15px;">Your memories list is empty. Add questions to start.</p>` : ''}
        </div>
    `;
    setTimeout(() => {
        const select = document.getElementById('mem-test-mode');
        const extraGroup = document.getElementById('extra-questions-group');
        if (select) {
            select.addEventListener('change', (e) => {
                extraGroup.style.display = e.target.value === 'memory_plus' ? 'block' : 'none';
            });
            if (select.value === 'memory_plus') extraGroup.style.display = 'block';
        }
    }, 0);
}
function renderPagedTest(app) {
    clearTimeout(state.timerId);
    const q = state.testQuestions[state.idx];
    if (!q) {
        finishAttempt();
        return;
    }
    const answered = state.answers[state.idx] !== undefined;
    const { timePerQuestion, total, timeLeft } = state.currentTestConfig;

    app.innerHTML = `
        ${renderHeader(state.currentTestConfig.title)}
        <div class="progress-bar-wrap"><div class="progress-bar" style="width:${((state.idx) / total) * 100}%"></div></div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: 500;">
            <span>Question ${state.idx + 1} of ${total}</span>
            ${timePerQuestion ? `<span>Time left: <b>${timeLeft}</b>s</span>` : ''}
        </div>
        <div class="question-card">
            <h3 style="font-weight:bold;">${escapeHtml(q.question)}</h3>
            ${q.img ? `<img src="${q.img}" class="question-img" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">` : ''}
            <div class="responses">
                ${q.shuffledResponses.map((r, j) => {
                    const isCorrect = q.shuffledMap[j] === q.correct;
                    const isSelected = state.answers[state.idx] === j;
                    let cls = 'response-box';
                    if (answered) {
                        if (isSelected && isCorrect) cls += ' correct';
                        else if (isSelected && !isCorrect) cls += ' wrong';
                        else if (isCorrect) cls += ' correct';
                    }
                    return `
                    <div class="${cls}" onclick="handlePagedAnswer(${j})">
                        <span class="response-prefix">${String.fromCharCode(65 + j)})</span>
                        <span>${escapeHtml(r)}</span>
                    </div>`;
                }).join('')}
            </div>
        </div>
        ${answered ? `<button onclick="nextPagedQuestion()" style="width:100%; padding: 15px; font-size: 1.2em;">${state.idx + 1 === total ? 'Finish' : 'Next Question'}</button>` : ''}
    `;

    if (timePerQuestion && !answered) {
        state.timerId = setTimeout(pagedTimerTick, 1000);
    }
}
function renderResults(app) {
    const { correctCount, total, wrongAnswers } = state.currentTestConfig.results;
    const score = total > 0 ? Math.round((correctCount / total) * 100) : 0;
    app.innerHTML = `
        ${renderHeader("Test Results")}
        <div class="score-bar">${correctCount} / ${total} (${score}%)</div>
        <div class="score-remark">${getScoreRemark(score)}</div>
        <div class="progress-bar-wrap" style="margin-top: 20px;"><div class="progress-bar" style="width:${score}%"></div></div>
        <div style="margin-top: 30px; text-align: center;">
            <button onclick="retryTest()">Try Again</button>
            <button class="btn-secondary" onclick="setView('menu')">Back to Main Menu</button>
        </div>
        <div style="margin-top: 30px;">
            <h3 style="border-bottom: 2px solid var(--border); padding-bottom: 10px;">
                Questions Answered Incorrectly (${wrongAnswers.length})
            </h3>
            ${wrongAnswers.length === 0
                ? `<p style="color: var(--correct); font-weight: 600;">Congratulations! You answered all questions correctly! 🎉</p>`
                : wrongAnswers.map(item => renderWrongReview(item.q)).join('')
            }
        </div>
    `;
}

function renderWrongReview(q) {
    const questionData = state.mainQuestionBank[q.originalIndex];
    if (!questionData) return '';

    return `
    <div class="question-card">
        <div style="font-weight:600;">Q${q.originalIndex + 1}: ${escapeHtml(questionData.question)}</div>
        ${questionData.img ? `<img src="${questionData.img}" class="question-img" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">`:''}
        <div class="responses">
            ${questionData.responses.map((r,j)=>{
                const isCorrect = (j === questionData.correct);
                let cls = "response-box";
                if(isCorrect) {
                    cls += " correct";
                }
                return `<div class="${cls}" style="cursor:default;">
                            <span class="response-prefix">${String.fromCharCode(65+j)})</span>
                            <span>${escapeHtml(r)}</span>
                        </div>`;
            }).join('')}
        </div>
    </div>`;
}

function renderInstruction(app) {
    app.innerHTML = `
    ${renderHeader("Instructions")}
    <div class="instruction-page">
      <p>Welcome! This guide explains what each button on the main menu does.</p>

      <h3>📖 Study Question</h3>
      <p>Practice questions with instant feedback. See right away if you are correct or wrong. Wrong answers are saved to your 'Memories List' to study later.</p>

      <h3>📝 Test Question</h3>
      <p>Take a test just like a real exam. Questions are shuffled. You get your score and see the answers only at the very end.</p>

      <h3>🏫 Moodle Test</h3>
      <p>A different test style that looks like Moodle. You can 'flag' questions to come back to them later and use a navigation panel to jump between questions.</p>
      
      <h3>⏱️ 60/60 Test</h3>
      <p>A fast-paced challenge. Answer 60 random questions with a time limit for each one. Choose your difficulty and test your speed.</p>

      <h3>⏳ Time Limit Test</h3>
      <p>Create your own timed test. Pick a range of questions and set how many seconds you get for each one.</p>

      <h3>🎯 Memories Test</h3>
      <p>Practice only the questions you've gotten wrong before. This test uses your personal 'Memories List' to help you improve.</p>
      
      <h3>🧠 Memories List</h3>
      <p>A special list of all questions you've answered incorrectly. You can also manually add or remove questions to study.</p>

      <h3>🏦 View Question Bank</h3>
      <p>See all the questions available in the app. You can add new questions, edit existing ones, or delete them here.</p>
      
      <h3>ℹ️ Instruction</h3>
      <p>You are here! This page explains what all the buttons do.</p>
    </div>
  `;
}

function renderEdit(app) {
    const q = state.editQ;
    if (!q) {
        setView('view_bank');
        return;
    }
    app.innerHTML = `
        ${renderHeader(state.editIdx === -1 ? 'Add New Question' : `Edit Question ${state.editIdx + 1}`)}
        <div class="setup-form">
            <div class="form-group">
                <label for="edit-q-text">Question Text (use &lt;br&gt; for line breaks):</label>
                <textarea id="edit-q-text" rows="3">${escapeHtml(q.question)}</textarea>
            </div>
            <div class="form-group">
                <label for="edit-q-img">Image URL (optional):</label>
                <input type="text" id="edit-q-img" value="${q.img || ''}">
            </div>
            <div id="responses-editor">
                ${q.responses.map((r, i) => `
                    <div class="form-group">
                        <label>Response ${i + 1}:</label>
                        <input type="text" class="response-input" value="${escapeHtml(r)}">
                    </div>
                `).join('')}
            </div>
            <div class="form-group">
                <label for="edit-q-correct">Correct Answer (1-${q.responses.length}):</label>
                <input type="number" id="edit-q-correct" min="1" max="${q.responses.length}" value="${q.correct + 1}">
            </div>
            <button onclick="saveQuestion()">Save Question</button>
            <button class="btn-secondary" onclick="setView('view_bank')">Cancel</button>
        </div>
    `;
}

// --- Event Handlers & Logic ---
function setView(view) {
    clearTimeout(state.timerId); 
    if (moodleQuiz && moodleQuiz.timerInterval) { 
        clearInterval(moodleQuiz.timerInterval);
    }
    state.view = view;
    render();
}

function updateTitle(element) {
    state.quizTitle = element.innerText;
}

function addNewQuestion() {
    state.editIdx = -1;
    state.editQ = {
        question: "",
        img: "",
        responses: ["", "", "", ""],
        correct: 0
    };
    setView('edit_question');
}

function editQuestion(index) {
    state.editIdx = index;
    state.editQ = JSON.parse(JSON.stringify(state.mainQuestionBank[index]));
    setView('edit_question');
}

function deleteQuestion(index) {
    if (confirm(`Are you sure you want to delete Question ${index + 1}?`)) {
        state.mainQuestionBank.splice(index, 1);
        state.memoriesList = state.memoriesList.filter(memIndex => memIndex !== index);
        state.memoriesList = state.memoriesList.map(memIndex => memIndex > index ? memIndex - 1 : memIndex);
        saveData();
        render();
    }
}

function saveQuestion() {
    const questionText = document.getElementById('edit-q-text').value;
    const imgUrl = document.getElementById('edit-q-img').value;
    const correct = parseInt(document.getElementById('edit-q-correct').value, 10) - 1;
    const responses = Array.from(document.querySelectorAll('.response-input')).map(input => input.value);

    if (!questionText || responses.some(r => !r) || isNaN(correct) || correct < 0 || correct >= responses.length) {
        alert("Please fill out all fields correctly.");
        return;
    }

    const newQuestion = {
        question: questionText,
        img: imgUrl,
        responses: responses,
        correct: correct
    };

    if (state.editIdx === -1) {
        state.mainQuestionBank.push(newQuestion);
    } else {
        state.mainQuestionBank[state.editIdx] = newQuestion;
    }
    setView('view_bank');
}

function addQuestionsToMemory() {
    const input = document.getElementById('add-mem-input').value;
    if (!input) return;

    const numbersToAdd = new Set();
    const parts = input.split(',');

    parts.forEach(part => {
        part = part.trim();
        if (part.includes('-')) {
            const [start, end] = part.split('-').map(n => parseInt(n.trim(), 10));
            if (!isNaN(start) && !isNaN(end) && start <= end) {
                for (let i = start; i <= end; i++) {
                    if (i >= 1 && i <= state.mainQuestionBank.length) {
                        numbersToAdd.add(i - 1);
                    }
                }
            }
        } else {
            const num = parseInt(part, 10);
            if (!isNaN(num) && num >= 1 && num <= state.mainQuestionBank.length) {
                numbersToAdd.add(num - 1);
            }
        }
    });

    const currentMemorySet = new Set(state.memoriesList);
    numbersToAdd.forEach(num => currentMemorySet.add(num));
    state.memoriesList = Array.from(currentMemorySet).sort((a, b) => a - b);
    saveData();
    render();
}

function deleteFromMemory(index) {
     if (confirm(`Are you sure you want to delete this question from your Memories List?`)) {
        state.memoriesList.splice(index, 1);
        saveData();
        render();
    }
}

function clearMemories() {
    if (state.memoriesList.length > 0 && confirm("Are you sure you want to clear all questions from your Memories List? This action cannot be undone.")) {
        state.memoriesList = [];
        saveData(); 
        render(); 
    }
}

function startTestFromRange(mode, wholeBank = false) {
    let from = 1, to = state.mainQuestionBank.length;
    if (!wholeBank) {
        from = parseInt(document.querySelector('.range-from').value || 1, 10);
        to = parseInt(document.querySelector('.range-to').value || state.mainQuestionBank.length, 10);
    }

    if (from < 1 || to > state.mainQuestionBank.length || from > to) {
        alert("Invalid range selected.");
        return;
    }

    let questionIndices = [];
    for (let i = from - 1; i < to; i++) {
        questionIndices.push(i);
    }

    let testQuestions = questionIndices.map(originalIndex => {
        const q = state.mainQuestionBank[originalIndex];
        return { ...q, originalIndex };
    });

    if (mode === 'test') {
        testQuestions = shuffle(testQuestions);
    }

    state.testQuestions = testQuestions.map(q => {
        const shuffledResponses = shuffle(q.responses);
        const shuffledMap = shuffledResponses.map(r => q.responses.indexOf(r));
        return { ...q, shuffledResponses, shuffledMap };
    });

    state.answers = new Array(state.testQuestions.length);
    state.currentTestConfig = { mode, from, to, wholeBank };
    setView(mode === 'study' ? 'study_test' : 'test_test');
}


function handleImmediateFeedback(questionIndex, responseIndex) {
    if (state.answers[questionIndex] !== undefined) return;
    state.answers[questionIndex] = responseIndex;
    render();
}

function finishAttempt() {
    let correctCount = 0;
    const wrongAnswers = [];
    const correctlyAnsweredIndices = new Set();

    state.testQuestions.forEach((q, i) => {
        const selectedResponseIndex = state.answers[i];
        if (selectedResponseIndex === undefined || selectedResponseIndex === -1) {
            wrongAnswers.push({ q });
            return;
        }
        const originalResponseIndex = q.shuffledMap[selectedResponseIndex];
        const isCorrect = originalResponseIndex === q.correct;

        if (isCorrect) {
            correctCount++;
            correctlyAnsweredIndices.add(q.originalIndex);
        } else {
            wrongAnswers.push({ q });
        }
    });

    const finalMemoryItems = new Set(state.memoriesList);

    wrongAnswers.forEach(item => {
        finalMemoryItems.add(item.q.originalIndex);
    });
    
    state.memoriesList = Array.from(finalMemoryItems).sort((a, b) => a - b);
    saveData();

    state.currentTestConfig.results = {
        correctCount,
        total: state.testQuestions.length,
        wrongAnswers
    };
    setView('results');
}

function retryTest() {
    const { mode, wholeBank } = state.currentTestConfig;
    if (mode === 'study' || mode === 'test') {
        startTestFromRange(mode, wholeBank);
    } else if (mode === 'sixty' || mode === 'timelimit' || mode === 'memory') {
        setView(mode + '_setup');
    }
}
function startPagedTest(mode, wholeBank = false) {
    let questions = [];
    let config = { mode };

    if (mode === 'sixty') {
        const time = parseInt(document.getElementById('difficulty').value, 10);
        questions = shuffle(state.mainQuestionBank).slice(0, 60).map((q, i) => ({...q, originalIndex: state.mainQuestionBank.indexOf(q)}));
        config.title = "60/60 Test";
        config.timePerQuestion = time;
    } else if (mode === 'timelimit') {
        const time = parseInt(document.getElementById('time-limit').value, 10);
        let from = 1, to = state.mainQuestionBank.length;
        if (!wholeBank) {
            from = parseInt(document.getElementById('range-from').value, 10);
            to = parseInt(document.getElementById('range-to').value, 10);
        }
        let indices = [];
        for (let i = from - 1; i < to; i++) indices.push(i);
        questions = shuffle(indices).map(i => ({...state.mainQuestionBank[i], originalIndex: i}));
        config.title = "Time Limit Test";
        config.timePerQuestion = time;
    } else if (mode === 'memory') {
        const testMode = document.getElementById('mem-test-mode').value;
        let memQuestions = state.memoriesList.map(i => ({...state.mainQuestionBank[i], originalIndex: i}));

        if (testMode === 'memory_plus') {
            const extraCount = parseInt(document.getElementById('extra-questions').value, 10);
            const bankIndices = state.mainQuestionBank.map((_,i) => i);
            const nonMemoryIndices = bankIndices.filter(i => !state.memoriesList.includes(i));
            const extraIndices = shuffle(nonMemoryIndices).slice(0, extraCount);
            const extraQuestions = extraIndices.map(i => ({...state.mainQuestionBank[i], originalIndex: i}));
            memQuestions = memQuestions.concat(extraQuestions);
        }
        questions = shuffle(memQuestions);
        config.title = "Memories Test";
    }

    state.testQuestions = questions.map(q => {
        const shuffledResponses = shuffle(q.responses);
        const shuffledMap = shuffledResponses.map(r => q.responses.indexOf(r));
        return { ...q, shuffledResponses, shuffledMap };
    });

    state.answers = new Array(state.testQuestions.length);
    state.idx = 0;
    config.total = state.testQuestions.length;
    if (config.timePerQuestion) {
        config.timeLeft = config.timePerQuestion;
    }
    state.currentTestConfig = config;
    setView('paged_test');
}

function handlePagedAnswer(responseIndex) {
    if (state.answers[state.idx] !== undefined) return;
    state.answers[state.idx] = responseIndex;
    clearTimeout(state.timerId);
    render();
}

function nextPagedQuestion() {
    if (state.idx < state.testQuestions.length - 1) {
        state.idx++;
        if (state.currentTestConfig.timePerQuestion) {
            state.currentTestConfig.timeLeft = state.currentTestConfig.timePerQuestion;
        }
        render();
    } else {
        finishAttempt();
    }
}

function pagedTimerTick() {
    if (!state.currentTestConfig) return;
    state.currentTestConfig.timeLeft--;
    if (state.currentTestConfig.timeLeft <= 0) {
        state.answers[state.idx] = -1; 
        clearTimeout(state.timerId);
        render(); 
        setTimeout(() => nextPagedQuestion(), 1500); 
    } else {
        const timerDisplay = document.querySelector("div[style*='space-between'] span b");
        if(timerDisplay) {
            timerDisplay.textContent = state.currentTestConfig.timeLeft;
        }
        state.timerId = setTimeout(pagedTimerTick, 1000);
    }
}


// --- START: MOODLE QUIZ INTEGRATION ---
function renderMoodleTest(app) {
    app.innerHTML = `
        ${renderHeader("Moodle Style Test")}
        <div id="moodle-quiz-container" class="text-slate-800 p-0 sm:p-4 rounded-lg">
             <div id="app-container" class="w-full max-w-6xl mx-auto">
                <div id="setup-screen" class="bg-white p-8 rounded-2xl shadow-lg text-center">
                    <h1 class="text-4xl font-bold text-slate-700 mb-4">Quiz Setup</h1>
                    <p class="text-slate-500 mb-8">Configure your quiz settings below.</p>
                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 mb-6">
                        <p class="text-lg font-semibold">Total questions in bank: <span id="total-questions-bank" class="text-blue-600">0</span></p>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="flex flex-col items-start">
                            <label for="num-questions" class="font-medium text-slate-600 mb-2">Number of Questions:</label>
                            <input type="number" id="num-questions" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" min="1" value="10">
                        </div>
                        <div class="flex flex-col items-start">
                            <label for="time-limit" class="font-medium text-slate-600 mb-2">Time Limit per Question:</label>
                            <select id="time-limit" class="w-full p-3 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="0">No Time Limit</option>
                                <option value="15">15 seconds</option>
                                <option value="30">30 seconds</option>
                                <option value="45">45 seconds</option>
                                <option value="60" selected>60 seconds</option>
                            </select>
                        </div>
                    </div>
                    <button id="start-quiz-btn" class="mt-8 w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        Start Quiz
                    </button>
                </div>

                <div id="quiz-screen" class="hidden">
                    <div class="grid lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-lg h-fit">
                            <h2 class="text-xl font-bold text-slate-700 mb-4 text-center">Quiz Navigation</h2>
                            <div id="quiz-navigation" class="grid grid-cols-5 gap-2"></div>
                        </div>
                        <div class="lg:col-span-9 bg-white p-8 rounded-2xl shadow-lg">
                            <div class="flex justify-between items-start mb-6">
                                <div class="text-lg font-semibold text-slate-700">
                                    Question <span id="question-number">1</span> of <span id="total-questions">10</span>
                                </div>
                                <div id="timer-container" class="hidden">
                                    <div class="w-full bg-gray-200 rounded-full h-2.5"><div id="timer-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 100%"></div></div>
                                    <div class="text-lg font-bold text-blue-600 text-right mt-1">Time Left: <span id="timer">60</span>s</div>
                                </div>
                            </div>
                            <div class="flex flex-col md:flex-row gap-6">
                                <div class="border border-slate-200 rounded-lg p-4 h-fit w-full md:w-48 flex-shrink-0 text-center md:text-left">
                                    <h3 id="info-box-q-number" class="font-bold text-md mb-2 text-slate-700">Question 1</h3>
                                    <p id="info-box-status" class="text-sm text-slate-500">Not complete</p>
                                    <p class="text-sm text-slate-500 mb-4">Marked out of 1.00</p>
                                    <button id="flag-btn" class="flex items-center justify-center md:justify-start gap-2 text-sm text-blue-600 hover:text-blue-800 transition w-full">
                                        <svg id="flag-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6H8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path></svg>
                                        <span id="flag-btn-text">Flag question</span>
                                    </button>
                                </div>
                                <div class="flex-grow">
                                    <div id="question-container" class="mb-6">
                                        <p id="question-text" class="text-xl leading-relaxed mb-4 text-slate-800"></p>
                                        <img id="question-image" src="" alt="Question Image" class="my-4 rounded-lg max-w-full h-auto mx-auto shadow-md hidden" onerror="this.style.display='none'">
                                    </div>
                                    <div id="options-container" class="space-y-3"></div>
                                </div>
                            </div>
                            <div class="mt-8 flex justify-between items-center">
                                <button id="prev-btn" class="bg-slate-200 text-slate-700 font-bold py-2 px-5 rounded-lg hover:bg-slate-300 transition">Previous</button>
                                <button id="next-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition">Next</button>
                                <button id="submit-btn" class="hidden bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700 transition">Submit Quiz</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="results-screen" class="hidden bg-white p-8 rounded-2xl shadow-lg text-center">
                    <h1 class="text-4xl font-bold text-slate-700 mb-2">Quiz Complete!</h1>
                    <p class="text-slate-500 mb-6">Here's how you did. Incorrect answers have been added to your Memories List.</p>
                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-6 mb-8 inline-block">
                        <p class="text-2xl font-semibold text-slate-700">Your Score</p>
                        <p class="text-5xl font-bold text-blue-600"><span id="score">0</span> / <span id="total-score">0</span></p>
                    </div>
                    <div class="flex justify-center gap-4">
                        <button id="review-incorrect-btn" class="bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-yellow-600 transition">Review Incorrect Answers</button>
                        <button id="restart-quiz-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition">Try Again</button>
                    </div>
                </div>

                <div id="review-screen" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-slate-700">Reviewing Incorrect Answers</h1>
                        <button id="back-to-results-btn" class="bg-slate-200 text-slate-700 font-bold py-2 px-5 rounded-lg hover:bg-slate-300 transition">Back to Results</button>
                    </div>
                    <div id="incorrect-questions-container" class="space-y-8"></div>
                </div>
            </div>
        </div>
    `;
    moodleQuiz.init();
}

const moodleQuiz = {
    currentQuizQuestions: [], userAnswers: [], flaggedQuestions: [],
    currentQuestionIndex: 0, timeLimit: 0, timerInterval: null,

    transformQuestionBank: function() {
        return state.mainQuestionBank.map((q, index) => ({
            question: q.question,
            image: q.img || null,
            options: q.responses,
            answer: q.responses[q.correct],
            originalIndex: index 
        }));
    },
    
    init: function() {
        this.setupScreen = document.getElementById('setup-screen');
        this.quizScreen = document.getElementById('quiz-screen');
        this.resultsScreen = document.getElementById('results-screen');
        this.reviewScreen = document.getElementById('review-screen');
        this.startQuizBtn = document.getElementById('start-quiz-btn');
        this.numQuestionsInput = document.getElementById('num-questions');
        this.timeLimitSelect = document.getElementById('time-limit');
        this.totalQuestionsBankEl = document.getElementById('total-questions-bank');
        this.questionNumberEl = document.getElementById('question-number');
        this.totalQuestionsEl = document.getElementById('total-questions');
        this.questionTextEl = document.getElementById('question-text');
        this.questionImageEl = document.getElementById('question-image');
        this.optionsContainer = document.getElementById('options-container');
        this.quizNavigation = document.getElementById('quiz-navigation');
        this.timerContainer = document.getElementById('timer-container');
        this.timerEl = document.getElementById('timer');
        this.timerBar = document.getElementById('timer-bar');
        this.prevBtn = document.getElementById('prev-btn');
        this.nextBtn = document.getElementById('next-btn');
        this.submitBtn = document.getElementById('submit-btn');
        this.scoreEl = document.getElementById('score');
        this.totalScoreEl = document.getElementById('total-score');
        this.restartQuizBtn = document.getElementById('restart-quiz-btn');
        this.reviewIncorrectBtn = document.getElementById('review-incorrect-btn');
        this.backToResultsBtn = document.getElementById('back-to-results-btn');
        this.incorrectQuestionsContainer = document.getElementById('incorrect-questions-container');
        this.infoBoxQNumber = document.getElementById('info-box-q-number');
        this.infoBoxStatus = document.getElementById('info-box-status');
        this.flagBtn = document.getElementById('flag-btn');
        this.flagBtnText = document.getElementById('flag-btn-text');
        this.flagIcon = document.getElementById('flag-icon');

        const questionBank = this.transformQuestionBank();
        this.totalQuestionsBankEl.textContent = questionBank.length;
        this.numQuestionsInput.max = questionBank.length;
        if (parseInt(this.numQuestionsInput.value) > questionBank.length && questionBank.length > 0) {
            this.numQuestionsInput.value = questionBank.length;
        }

        this.setupScreen.classList.remove('hidden');
        this.quizScreen.classList.add('hidden');
        this.resultsScreen.classList.add('hidden');
        this.reviewScreen.classList.add('hidden');
        
        this.startQuizBtn.addEventListener('click', () => this.startQuiz());
        this.nextBtn.addEventListener('click', () => this.goToNextQuestion());
        this.prevBtn.addEventListener('click', () => this.goToPrevQuestion());
        this.submitBtn.addEventListener('click', () => this.submitQuiz());
        this.restartQuizBtn.addEventListener('click', () => this.init());
        this.reviewIncorrectBtn.addEventListener('click', () => this.showReviewScreen());
        this.flagBtn.addEventListener('click', () => this.toggleFlag(this.currentQuestionIndex));
        this.backToResultsBtn.addEventListener('click', () => {
            this.reviewScreen.classList.add('hidden');
            this.resultsScreen.classList.remove('hidden');
        });
    },

    startQuiz: function() {
        const questionBank = this.transformQuestionBank();
        const numQuestions = parseInt(this.numQuestionsInput.value);
        this.timeLimit = parseInt(this.timeLimitSelect.value);

        if (isNaN(numQuestions) || numQuestions <= 0 || numQuestions > questionBank.length) {
            alert("Please enter a valid number of questions.");
            this.numQuestionsInput.focus();
            return;
        }

        this.currentQuizQuestions = this.shuffleArray(questionBank).slice(0, numQuestions);
        this.userAnswers = new Array(numQuestions).fill(null);
        this.flaggedQuestions = new Array(numQuestions).fill(false);
        this.currentQuestionIndex = 0;

        this.setupScreen.classList.add('hidden');
        this.quizScreen.classList.remove('hidden');

        this.buildNavigation();
        this.loadQuestion(this.currentQuestionIndex);
    },

    loadQuestion: function(index) {
        clearInterval(this.timerInterval);

        const question = this.currentQuizQuestions[index];
        this.questionNumberEl.textContent = index + 1;
        this.totalQuestionsEl.textContent = this.currentQuizQuestions.length;
        this.questionTextEl.innerHTML = escapeHtml(question.question); 

        this.infoBoxQNumber.textContent = `Question ${index + 1}`;
        this.infoBoxStatus.textContent = this.userAnswers[index] ? 'Answer saved' : 'Not complete';
        this.updateFlagStatusUI(index);

        if (question.image) {
            this.questionImageEl.src = question.image;
            this.questionImageEl.classList.remove('hidden');
        } else {
            this.questionImageEl.classList.add('hidden');
        }

        this.optionsContainer.innerHTML = '';
        const shuffledOptions = this.shuffleArray([...question.options]);
        shuffledOptions.forEach(option => {
            const optionId = `q${index}_option_${option.replace(/\s+/g, '')}`;
            const isChecked = this.userAnswers[index] && this.userAnswers[index].selected === option;
            
            const optionElement = document.createElement('label');
            optionElement.htmlFor = optionId;
            optionElement.className = "flex items-center w-full p-3 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 transition";
            
            optionElement.innerHTML = `
                <input type="radio" id="${optionId}" name="question${index}" value="${option}" class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 focus:ring-2" ${isChecked ? 'checked' : ''}>
                <span class="ml-3 text-slate-700">${escapeHtml(option)}</span>
            `;
            this.optionsContainer.appendChild(optionElement);
        });

        if (this.userAnswers[index]) {
            this.showAnswerFeedback(index);
        } else {
            document.querySelectorAll(`input[name="question${index}"]`).forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isCorrect = e.target.value === this.currentQuizQuestions[this.currentQuestionIndex].answer;
                    this.userAnswers[this.currentQuestionIndex] = { selected: e.target.value, correct: isCorrect };
                    this.infoBoxStatus.textContent = 'Answer saved';
                    this.updateNavButton(this.currentQuestionIndex, isCorrect);
                    this.showAnswerFeedback(this.currentQuestionIndex);
                });
            });
        }

        this.updateNavigationHighlight();
        this.updateButtonVisibility();
        
        if (this.timeLimit > 0 && !this.userAnswers[index]) {
            this.startTimer();
        } else {
            this.timerContainer.classList.add('hidden');
        }
    },
    
    showAnswerFeedback: function(index) {
        const correctAnswer = this.currentQuizQuestions[index].answer;
        const userAnswer = this.userAnswers[index];
        
        document.querySelectorAll(`input[name="question${index}"]`).forEach(radio => {
            radio.disabled = true;
            const label = radio.parentElement;
            label.classList.remove('hover:bg-slate-50', 'cursor-pointer');
            
            if (radio.value === correctAnswer) {
                label.classList.add('option-correct');
            } else if (userAnswer && radio.value === userAnswer.selected) {
                label.classList.add('option-incorrect');
            }
        });
    },

    toggleFlag: function(index) {
        this.flaggedQuestions[index] = !this.flaggedQuestions[index];
        this.updateFlagStatusUI(index);
        this.updateNavButton(index, this.userAnswers[index]?.correct);
    },

    updateFlagStatusUI: function(index) {
        const isFlagged = this.flaggedQuestions[index];
        this.flagBtnText.textContent = isFlagged ? 'Unflag question' : 'Flag question';
        this.flagIcon.classList.toggle('text-amber-500', isFlagged);
        this.flagIcon.classList.toggle('text-current', !isFlagged);
    },

    startTimer: function() {
        this.timerContainer.classList.remove('hidden');
        let timeLeft = this.timeLimit;
        this.timerEl.textContent = timeLeft;
        this.timerBar.style.width = '100%';
        
        this.timerInterval = setInterval(() => {
            timeLeft--;
            this.timerEl.textContent = timeLeft;
            this.timerBar.style.width = `${(timeLeft / this.timeLimit) * 100}%`;

            if (timeLeft <= 0) {
                clearInterval(this.timerInterval);
                if (!this.userAnswers[this.currentQuestionIndex]) {
                     this.userAnswers[this.currentQuestionIndex] = { selected: null, correct: false };
                     this.updateNavButton(this.currentQuestionIndex, false);
                     this.showAnswerFeedback(this.currentQuestionIndex);
                }
                setTimeout(() => this.goToNextQuestion(), 1000); 
            }
        }, 1000);
    },

    buildNavigation: function() {
        this.quizNavigation.innerHTML = '';
        for (let i = 0; i < this.currentQuizQuestions.length; i++) {
            const navBtn = document.createElement('button');
            navBtn.classList.add('nav-btn', 'font-bold', 'py-2', 'rounded', 'nav-btn-default');
            navBtn.innerHTML = `<span>${i + 1}</span><span class="flag-icon"></span>`;
            navBtn.addEventListener('click', () => {
                this.currentQuestionIndex = i;
                this.loadQuestion(i);
            });
            this.quizNavigation.appendChild(navBtn);
        }
    },

    updateNavigationHighlight: function() {
        const navButtons = this.quizNavigation.children;
        for (let i = 0; i < navButtons.length; i++) {
            navButtons[i].classList.remove('nav-btn-current');
            if (i === this.currentQuestionIndex) {
                navButtons[i].classList.add('nav-btn-current');
            }
        }
    },

    updateNavButton: function(index, isCorrect) {
        const navButton = this.quizNavigation.children[index];
        navButton.classList.remove('nav-btn-default', 'nav-btn-correct', 'nav-btn-incorrect');
        
        if (this.userAnswers[index] === null) {
            navButton.classList.add('nav-btn-default');
        } else if (isCorrect) {
            navButton.classList.add('nav-btn-correct');
        } else {
            navButton.classList.add('nav-btn-incorrect');
        }

        const flagIconEl = navButton.querySelector('.flag-icon');
        flagIconEl.innerHTML = this.flaggedQuestions[index] ? '&#9873;' : '';
    },
    
    updateButtonVisibility: function() {
        this.prevBtn.style.visibility = this.currentQuestionIndex === 0 ? 'hidden' : 'visible';
        if (this.currentQuestionIndex === this.currentQuizQuestions.length - 1) {
            this.nextBtn.classList.add('hidden');
            this.submitBtn.classList.remove('hidden');
        } else {
            this.nextBtn.classList.remove('hidden');
            this.submitBtn.classList.add('hidden');
        }
    },

    goToNextQuestion: function() {
        if (this.currentQuestionIndex < this.currentQuizQuestions.length - 1) {
            this.currentQuestionIndex++;
            this.loadQuestion(this.currentQuestionIndex);
        } else {
            this.submitQuiz();
        }
    },
    
    goToPrevQuestion: function() {
        if (this.currentQuestionIndex > 0) {
            this.currentQuestionIndex--;
            this.loadQuestion(this.currentQuestionIndex);
        }
    },

    submitQuiz: function() {
        clearInterval(this.timerInterval);
        const score = this.userAnswers.filter(answer => answer && answer.correct).length;
        this.scoreEl.textContent = score;
        this.totalScoreEl.textContent = this.currentQuizQuestions.length;
        
        const newMemoryItems = new Set(state.memoriesList);
        this.userAnswers.forEach((answer, index) => {
            if (!answer || !answer.correct) {
                const question = this.currentQuizQuestions[index];
                newMemoryItems.add(question.originalIndex);
            }
        });
        state.memoriesList = Array.from(newMemoryItems).sort((a, b) => a - b);
        saveData(); 
        
        this.quizScreen.classList.add('hidden');
        this.resultsScreen.classList.remove('hidden');

        const incorrectCount = this.currentQuizQuestions.length - score;
        this.reviewIncorrectBtn.style.display = incorrectCount > 0 ? 'inline-block' : 'none';
    },

    showReviewScreen: function() {
        this.resultsScreen.classList.add('hidden');
        this.reviewScreen.classList.remove('hidden');
        this.incorrectQuestionsContainer.innerHTML = '';

        this.currentQuizQuestions.forEach((question, index) => {
            const userAnswer = this.userAnswers[index];
            if (!userAnswer || !userAnswer.correct) {
                const questionEl = document.createElement('div');
                questionEl.className = 'bg-white p-6 rounded-lg shadow-md border-l-4 border-red-500';
                
                let optionsHtml = '';
                question.options.forEach(option => {
                    let labelClass = 'text-slate-700';
                    let indicator = '';
                    if (option === question.answer) {
                        labelClass = 'text-green-600 font-bold';
                        indicator = ' (Correct Answer)';
                    } else if (userAnswer && option === userAnswer.selected) {
                        labelClass = 'text-red-600 font-bold';
                        indicator = ' (Your Answer)';
                    }
                    optionsHtml += `<li class="${labelClass}">${escapeHtml(option)}${indicator}</li>`;
                });
                
                let imageHtml = question.image ? `<img src="${question.image}" class="my-4 rounded-lg max-w-xs h-auto shadow-sm">` : '';

                questionEl.innerHTML = `
                    <p class="text-lg font-semibold mb-2 text-slate-800">Question ${index + 1}: ${escapeHtml(question.question)}</p>
                    ${imageHtml}
                    <ul class="list-disc list-inside space-y-1 mt-4">
                        ${optionsHtml}
                    </ul>
                `;
                this.incorrectQuestionsContainer.appendChild(questionEl);
            }
        });
    },

    shuffleArray: function(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
};
// --- END: MOODLE QUIZ INTEGRATION ---


// --- Initial Load ---
window.onload = () => {
  loadData();
  state.isMuted = true; // Always default to muted on page load
  setupAudio();
  render();
};
</script>
</body>
</html>